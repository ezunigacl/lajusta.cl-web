<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Justa | Simulador de Pensión PRO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@1&family=Inter:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // Global variables for current UF value
        let currentUF = 37985.50; 
        let currentUTM = 66628;
        const defaultUFValue = 37985.50; 

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ocean: '#022C43',
                        oceanLight: '#053B58',
                        oceanDark: '#011826',
                        acid: '#CCFF00',
                        acidHover: '#b3e600',
                        lightText: '#E6F4F1'
                    },
                    fontFamily: {
                        serif: ['Instrument Serif', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    },
                    keyframes: {
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.5s ease-out forwards',
                    },
                }
            }
        }
    </script>

    <style>
        body { background-color: #022C43; color: #E6F4F1; overflow-x: hidden; }
        .font-serif { font-family: 'Instrument Serif', serif; font-style: italic; }
        .font-mono { font-family: 'Space Mono', monospace; }
        .text-glow { text-shadow: 0 0 20px rgba(204, 255, 0, 0.4); }
        .glass-panel { 
            background: rgba(5, 59, 88, 0.3); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .grid-bg { 
            background-image: linear-gradient(rgba(204, 255, 0, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(204, 255, 0, 0.03) 1px, transparent 1px); 
            background-size: 40px 40px; background-position: center top;
        }
        .btn-3d { transition: all 0.1s ease; box-shadow: 4px 4px 0px rgba(0,0,0,0.5); }
        .btn-3d:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.5); }
        
        .input-premium {
            background: rgba(1, 24, 38, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
            font-family: 'Space Mono', monospace;
        }
        .input-premium:focus { 
            border-color: #CCFF00; 
            outline: none; 
            box-shadow: 0 0 10px rgba(204, 255, 0, 0.2); 
            background: rgba(1, 24, 38, 0.8);
        }
        .input-error { border-color: #ef4444 !important; }
        .input-success { border-color: #22c55e !important; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #022C43; }
        ::-webkit-scrollbar-thumb { background: #053B58; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #CCFF00; }
    </style>
</head>
<body class="grid-bg relative antialiased selection:bg-acid selection:text-ocean">

    <!-- Notificaciones Estándar (Copiado de Index) -->
    <div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 hidden z-[1000] transition-all duration-300 max-w-sm w-full animate-fade-in-up" role="alert">
        <div class="p-4 rounded-xl shadow-xl font-mono" id="messageBoxContent">
            <p id="messageText" class="font-bold text-center"></p>
        </div>
    </div>

    <!-- Navegación Estándar (Copiada de Index) -->
    <nav class="fixed w-full z-50 glass-panel border-b-0 border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-6">
                    <a href="index.html" class="flex items-center gap-3 group flex-shrink-0">
                        <img src="Logo.jpg" alt="Logo" class="h-10 w-10 rounded-lg border border-white/10 group-hover:border-acid transition-colors object-cover">
                        <span class="font-serif text-2xl md:text-3xl text-acid tracking-wide">La Justa<span class="text-white">.</span></span>
                    </a>
                    <div class="hidden lg:flex items-center gap-4 bg-oceanLight/30 border border-white/10 px-4 py-1.5 rounded-lg backdrop-blur-md">
                        <div class="flex flex-col items-start leading-none border-r border-white/10 pr-4">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-0.5">UF HOY</span>
                            <span id="navUF" class="font-mono text-white text-xs font-bold animate-pulse">...</span>
                        </div>
                        <div class="flex flex-col items-start leading-none">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-0.5">UTM MES</span>
                            <span id="navUTM" class="font-mono text-white text-xs font-bold animate-pulse">...</span>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8 font-mono text-sm">
                        <a href="index.html" class="text-white hover:text-acid transition-colors duration-300">INICIO</a>
                        <a href="index.html#que-hacemos" class="text-white hover:text-acid transition-colors duration-300">SERVICIOS</a>
                        <a href="simulador.html" class="text-acid hover:text-white transition-colors duration-300 glow-sm">[ HERRAMIENTAS ]</a>
                        <a href="index.html#login" class="border border-acid text-acid px-4 py-2 hover:bg-acid hover:text-ocean transition-all duration-300 btn-3d">ACCESO</a>
                    </div>
                </div>
                <div class="md:hidden">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-white hover:text-acid p-2 focus:outline-none">
                        <i data-lucide="menu" class="w-8 h-8"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-oceanDark/95 backdrop-blur-xl border-t border-white/10 absolute w-full left-0">
            <div class="px-4 pt-2 pb-6 space-y-2 font-mono text-sm">
                <a href="index.html" class="block px-3 py-4 text-white hover:text-acid border-b border-white/5">INICIO</a>
                <a href="simulador.html" class="block px-3 py-4 text-acid font-bold border-b border-white/5">SIMULADOR</a>
                <a href="auditorscomp.html" class="block px-3 py-4 text-white hover:text-acid border-b border-white/5">AUDITOR SCOMP</a>
                <a href="index.html#login" class="block px-3 py-4 text-acid hover:text-white border-b border-white/5">ACCESO</a>
            </div>
        </div>
    </nav>

    <div class="pt-32 lg:pt-40"></div>

    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 mb-20 flex-grow">
        
        <div class="text-center mb-10 animate-fade-in-up">
            <span class="font-mono text-acid text-xs tracking-[0.3em] uppercase mb-2 block">Motor Actuarial V3 PRO</span>
            <h1 class="font-serif text-4xl md:text-5xl text-white mb-4">Simulador de Pensión</h1>
            <p class="text-gray-400 max-w-lg mx-auto text-sm font-sans leading-relaxed">
                Proyección matemática basada en interés compuesto y tablas de mortalidad ajustadas para el mercado chileno.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            
            <!-- Sidebar Izquierda (Entradas) -->
            <div class="lg:col-span-4 space-y-8 animate-fade-in-up" style="animation-delay: 0.1s;">
                
                <!-- 1. Perfil Personal -->
                <div class="glass-panel rounded-xl overflow-hidden border-white/10">
                    <div class="p-6 border-b border-white/10 bg-oceanLight/30 flex items-center gap-3">
                        <span class="bg-acid text-ocean w-7 h-7 rounded-full flex items-center justify-center font-bold text-sm font-mono">1</span>
                        <h2 class="text-xl font-serif italic text-white uppercase tracking-wide">Perfil Personal</h2>
                    </div>
                    <div class="p-6 space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-1.5 ml-1">Nombre</label>
                                <input type="text" id="inputName" class="input-premium w-full rounded-lg px-3 py-2 text-sm" placeholder="Ej: Emilia">
                            </div>
                            <div>
                                <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-1.5 ml-1">Apellido</label>
                                <input type="text" id="inputLastName" class="input-premium w-full rounded-lg px-3 py-2 text-sm" placeholder="Ej: Clarke">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-1.5 ml-1">RUT</label>
                            <div class="relative">
                                <input type="text" id="inputRut" class="input-premium w-full rounded-lg px-3 py-2 font-mono text-sm" placeholder="12.345.678-9" maxlength="12">
                                <span id="rutStatusIcon" class="absolute right-3 top-2 hidden"></span>
                            </div>
                            <p id="rutErrorMsg" class="text-[10px] text-red-400 mt-1 hidden font-bold">RUT Inválido</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-1.5 ml-1">Email</label>
                                <div class="relative">
                                    <input type="email" id="inputEmail" class="input-premium w-full rounded-lg px-3 py-2 text-xs" placeholder="ejemplo@correo.com">
                                    <span id="emailStatusIcon" class="absolute right-3 top-2 hidden"></span>
                                </div>
                                <p id="emailErrorMsg" class="text-[10px] text-red-400 mt-1 hidden font-bold">Email Inválido</p>
                            </div>
                            <div>
                                <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-1.5 ml-1">Teléfono</label>
                                <div class="relative">
                                    <input type="tel" id="inputPhone" class="input-premium w-full rounded-lg px-3 py-2 font-mono text-xs" placeholder="912345678" maxlength="9">
                                    <span id="phoneStatusIcon" class="absolute right-3 top-2 hidden"></span>
                                </div>
                                <p id="phoneErrorMsg" class="text-[10px] text-red-400 mt-1 hidden font-bold">Formato: 9xxxxxxxx</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-mono font-bold text-white/50 uppercase tracking-widest block mb-1.5 ml-1">Nacimiento</label>
                                <input type="date" id="inputDob" class="input-premium w-full rounded-lg px-2 py-2 text-xs">
                            </div>
                            <div>
                                <label class="text-[10px] font-mono font-bold text-white/50 uppercase tracking-widest block mb-1.5 ml-1">Género</label>
                                <select id="inputGender" class="input-premium w-full rounded-lg px-2 py-2 text-xs cursor-pointer appearance-none">
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-mono font-bold text-white/50 uppercase tracking-widest block mb-1.5 ml-1">AFP Actual</label>
                            <select id="inputAFP" class="input-premium w-full rounded-lg px-2 py-2 text-xs cursor-pointer appearance-none">
                                <option value="habitat">Habitat</option>
                                <option value="modelo">Modelo</option>
                                <option value="provida">Provida</option>
                                <option value="capital">Capital</option>
                                <option value="cuprum">Cuprum</option>
                                <option value="planvital">PlanVital</option>
                            </select>
                        </div>
                        <div class="bg-emerald-900/10 p-4 rounded-lg border border-emerald-500/20">
                            <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-2 flex items-center gap-1">
                                <i data-lucide="trending-up" class="w-3 h-3"></i> Promedio Renta (10 años)
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-white/30 font-mono text-sm">$</span>
                                <input type="text" id="inputAvgSalary" class="input-premium w-full rounded-lg pl-8 py-2 font-mono font-bold text-acid text-glow currency-input" placeholder="0">
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 p-3 rounded-lg bg-oceanLight/20 border border-white/5 cursor-pointer hover:bg-oceanLight/30 transition-colors">
                                <input type="checkbox" id="flagBeneficiaries" class="w-4 h-4 rounded text-acid focus:ring-acid border-white/20 bg-oceanDark">
                                <span class="text-[10px] font-mono font-bold text-white/70 uppercase tracking-widest">¿Posee Beneficiarios?</span>
                            </label>
                        </div>
                        <div id="beneficiariesSection" class="hidden pl-4 border-l-2 border-acid/50 space-y-4 bg-oceanLight/10 p-4 rounded-r-lg">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="checkSpouse" class="w-4 h-4 rounded text-acid border-white/20 bg-oceanDark">
                                <span class="text-xs font-mono font-bold text-white/60">Es Cónyuge / Pareja Civil</span>
                            </label>
                            <div id="spouseDobContainer" class="hidden">
                                <label class="text-[9px] font-mono font-bold text-white/30 uppercase tracking-widest block mb-1">Nacimiento Cónyuge</label>
                                <input type="date" id="inputSpouseDob" class="input-premium w-full rounded-lg px-2 py-1.5 text-xs">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-1.5 ml-1">Tramo RSH (PGU)</label>
                            <select id="inputRSH" class="input-premium w-full rounded-lg px-2 py-2 text-xs cursor-pointer appearance-none">
                                <option value="-1">Sin información</option>
                                <option value="90">0% - 90% (Califica)</option>
                                <option value="100">91% - 100% (No califica)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 2. Patrimonio -->
                <div class="glass-panel rounded-xl overflow-hidden border-white/10">
                    <div class="p-6 border-b border-white/10 bg-oceanLight/30 flex items-center gap-3">
                        <span class="bg-acid text-ocean w-7 h-7 rounded-full flex items-center justify-center font-bold text-sm font-mono">2</span>
                        <h2 class="text-xl font-serif italic text-white uppercase tracking-wide">Patrimonio</h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-oceanDark/40 p-4 rounded-xl border border-white/5 space-y-4">
                            <div>
                                <label class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest block mb-1 flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3"></i> Saldo CCI (AFP)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-white/30 font-mono">$</span>
                                    <input type="text" id="inputBalance" class="input-premium w-full rounded-lg pl-8 py-2.5 font-mono font-bold text-acid text-glow currency-input" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-mono font-bold text-white/40 uppercase tracking-widest block mb-1">Bono Reconocimiento</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-white/20 font-mono">$</span>
                                    <input type="text" id="inputBonoRec" class="input-premium w-full rounded-lg pl-8 py-2 font-mono text-sm currency-input" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-mono font-bold text-white/40 uppercase tracking-widest block mb-1">Saldo APV</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-white/20 font-mono">$</span>
                                    <input type="text" id="inputApv" class="input-premium w-full rounded-lg pl-8 py-2 font-mono text-sm currency-input" placeholder="0">
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-900/10 p-4 rounded-xl border border-purple-500/20 space-y-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="checkELD" class="w-4 h-4 rounded text-purple-400 border-white/20 bg-oceanDark">
                                <span class="text-[11px] font-mono font-bold text-purple-300 uppercase tracking-widest">Retirar Excedente (ELD)</span>
                            </label>
                            <div id="eldInputContainer" class="hidden mt-2 relative">
                                <label class="text-[9px] font-mono text-purple-400 uppercase block mb-1">Monto a Retirar</label>
                                <span class="absolute left-3 top-7 text-purple-500 font-mono">$</span>
                                <input type="text" id="inputELDAmount" class="input-premium w-full rounded-lg pl-8 py-2 font-mono text-purple-200 border-purple-500/30 currency-input" placeholder="0">
                            </div>
                        </div>
                        <div class="bg-oceanDark/40 p-4 rounded-lg border border-white/5">
                             <label class="text-[10px] font-mono font-bold text-white/40 uppercase tracking-widest block mb-1 flex items-center gap-1">
                                <i data-lucide="calendar" class="w-3 h-3"></i> Años Cotizados
                             </label>
                             <input type="number" id="inputYearsQuoted" class="input-premium w-full rounded-lg px-3 py-2 text-sm" placeholder="Ej: 25">
                        </div>
                    </div>
                </div>

                <!-- 3. Configuración -->
                <div class="glass-panel rounded-xl overflow-hidden border-acid/20 relative shadow-acid/10">
                    <div class="absolute top-0 left-0 w-1 h-full bg-acid"></div>
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-5">
                            <i data-lucide="sliders" class="text-acid w-5 h-5"></i>
                            <h2 class="text-xl font-serif italic text-white uppercase tracking-wide">Configuración</h2>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex flex-col gap-1 p-3 rounded-lg bg-oceanDark/50 border border-white/5 hover:border-acid/30 transition-all cursor-pointer">
                                    <input type="checkbox" class="sim-check w-4 h-4 accent-acid" value="rp" checked>
                                    <span class="text-[9px] font-mono font-bold text-white/50 mt-1 uppercase tracking-widest">RETIRO PROG.</span>
                                </label>
                                <label class="flex flex-col gap-1 p-3 rounded-lg bg-oceanDark/50 border border-white/5 hover:border-acid/30 transition-all cursor-pointer">
                                    <input type="checkbox" class="sim-check w-4 h-4 accent-acid" value="rv_simple" checked>
                                    <span class="text-[9px] font-mono font-bold text-white/50 mt-1 uppercase tracking-widest">RENTA VITALICIA</span>
                                </label>
                            </div>
                            <div>
                                <span class="text-[10px] font-mono font-bold text-white/30 uppercase tracking-[0.2em] mb-2 block">Garantizados RV</span>
                                <div class="grid grid-cols-2 gap-2 bg-oceanDark/30 p-3 rounded-lg border border-white/5">
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_gar_120" checked><span class="text-[10px] font-mono text-white/60 uppercase">120m</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_gar_180" checked><span class="text-[10px] font-mono text-white/60 uppercase">180m</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_gar_240" checked><span class="text-[10px] font-mono text-white/60 uppercase">240m</span></label>
                                    <label class="flex items-center gap-2 p-1 border border-dashed border-white/10 rounded bg-oceanLight/10">
                                        <input type="checkbox" class="sim-check w-3 h-3 accent-acid" id="checkCustomGar">
                                        <input type="number" id="inputCustomGarMonths" class="w-12 text-[10px] bg-transparent text-acid font-bold focus:outline-none" placeholder="Mes" disabled>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-acid/10 p-4 rounded-lg border border-acid/20">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-[10px] font-mono font-bold text-acid uppercase tracking-widest flex items-center gap-2">
                                        <i data-lucide="zap" class="w-3 h-3"></i> Renta Aumentada
                                    </span>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="inputIncreasePct" value="100" class="w-12 text-center text-xs font-mono bg-oceanDark border border-acid/30 rounded py-0.5 text-acid focus:ring-0">
                                        <span class="text-[10px] text-acid font-bold">%</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_inc_12" checked><span class="text-[9px] font-mono text-white/40">12m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_inc_24" checked><span class="text-[9px] font-mono text-white/40">24m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_inc_36"><span class="text-[9px] font-mono text-white/40">36m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_inc_48"><span class="text-[9px] font-mono text-white/40">48m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check w-3 h-3 accent-acid" value="rv_inc_60"><span class="text-[9px] font-mono text-white/40">60m</span></label>
                                    <label class="flex items-center gap-1 p-1 border border-dashed border-white/10 rounded">
                                        <input type="checkbox" class="sim-check w-3 h-3 accent-acid" id="checkCustomInc">
                                        <input type="number" id="inputCustomIncMonths" class="w-8 text-[9px] bg-transparent text-acid font-bold focus:outline-none" placeholder="m" disabled>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="btnSimulate" onclick="runSimulation()" class="btn-3d w-full bg-acid text-ocean font-extrabold py-5 rounded-xl uppercase tracking-[0.2em] text-sm flex justify-center items-center gap-3 group">
                    <span>Simular Pensión</span>
                    <i data-lucide="rocket" class="w-5 h-5 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
                </button>
            </div>

            <!-- Right Content (Resultados) -->
            <div class="lg:col-span-8 space-y-10">
                <div id="placeholderState" class="h-full min-h-[600px] flex flex-col items-center justify-center glass-panel rounded-3xl p-12 text-center border-dashed border-white/10">
                    <div class="w-24 h-24 bg-acid/10 rounded-full flex items-center justify-center mb-8 ring-4 ring-acid/5">
                        <i data-lucide="area-chart" class="w-10 h-10 text-acid"></i>
                    </div>
                    <h3 class="text-3xl font-serif italic font-bold text-white mb-4 text-glow">Resultados de Simulación</h3>
                    <p class="text-gray-400 max-w-sm mx-auto leading-relaxed">Ingresa tus datos y presiona **Simular** para desplegar el análisis actuarial profesional.</p>
                </div>

                <div id="resultsDashboard" class="hidden space-y-10 animate-fade-in-up">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-oceanDark/40 p-6 rounded-2xl border border-white/5">
                        <div>
                            <h1 class="text-3xl font-serif italic text-white text-glow">Resultados Consolidados</h1>
                            <p class="text-[10px] font-mono text-white/30 uppercase tracking-widest mt-1">/ Informe_Generado_Exitosamente</p>
                        </div>
                        <button id="btnDownloadPDF" class="btn-3d bg-white text-ocean px-6 py-3 font-mono font-bold text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-acid transition-all">
                            <i data-lucide="file-text" class="w-4 h-4"></i> EXPORTAR INFORME PDF
                        </button>
                    </div>
                    
                    <div id="tablesContainer" class="space-y-10"></div>

                    <div class="glass-panel p-10 rounded-3xl shadow-2xl border-white/5 overflow-hidden relative">
                        <div class="absolute top-0 right-0 p-8 opacity-5"><i data-lucide="activity" class="w-32 h-32 text-acid"></i></div>
                        <div class="flex justify-between items-center mb-10 relative z-10">
                            <div>
                                <h3 class="text-2xl font-serif italic text-white uppercase tracking-wide">Proyección Flujo de Caja</h3>
                                <p class="text-[10px] text-white/40 font-mono mt-2 tracking-widest uppercase">Simulación a 20 años bajo parámetros normativos SP</p>
                            </div>
                        </div>
                        <div class="chart-container relative h-[450px] w-full z-10">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Estándar (Copiado de Index) -->
    <footer class="bg-oceanDark pt-20 pb-10 border-t border-white/10 text-sm mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center md:text-left">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
                <div class="col-span-1 md:col-span-2">
                    <div class="flex items-center gap-3 mb-6 justify-center md:justify-start">
                        <img src="Logo.jpg" alt="Logo" class="h-10 w-10 rounded-md border border-white/10 opacity-80 grayscale hover:grayscale-0 transition-all">
                        <span class="font-serif text-4xl text-white italic tracking-wide">La Justa<span class="text-acid">.</span></span>
                    </div>
                    <p class="text-gray-500 max-w-sm font-sans leading-relaxed">Reingeniería financiera para una nueva generación. Democratizando el acceso a datos previsionales reales.</p>
                </div>
                <div>
                    <h4 class="font-mono text-acid text-xs uppercase mb-6 tracking-[0.2em] font-bold">Navegación</h4>
                    <ul class="space-y-3 font-mono text-gray-400 text-xs">
                        <li><a href="index.html" class="hover:text-white transition-colors uppercase tracking-widest">Inicio</a></li>
                        <li><a href="simulador.html" class="hover:text-acid transition-colors uppercase tracking-widest">Simulador PRO</a></li>
                        <li><a href="index.html#metodologia" class="hover:text-white transition-colors uppercase tracking-widest">Metodología</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-mono text-acid text-xs uppercase mb-6 tracking-[0.2em] font-bold">Legal</h4>
                    <ul class="space-y-3 font-mono text-gray-400 text-xs">
                        <li><a href="#" class="hover:text-white transition-colors uppercase tracking-widest">Términos</a></li>
                        <li><a href="#" class="hover:text-white transition-colors uppercase tracking-widest">Privacidad</a></li>
                        <li><a href="#" class="hover:text-white transition-colors uppercase tracking-widest">Cookies</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-white/5 pt-10 flex flex-col md:flex-row justify-between items-center text-[10px] text-gray-600 font-mono tracking-widest uppercase">
                <p>&copy; 2025 La Justa Fintech SpA. Todos los derechos reservados.</p>
                <p class="mt-4 md:mt-0 text-gray-500">DISCLAIMER: Las proyecciones son referenciales y no constituyen asesoría legal.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- Constantes Actuariales ---
        const PGU_FACTOR_MAX_UF = 5.64;
        const PGU_THRESHOLD_FULL_PAFE = 729530; 
        const PGU_THRESHOLD_MAX_PAFE = 1158355; 
        const RATE_RP = 0.0341; 
        const RATE_RV = 0.0325; 
        const RATE_FONDO_C = 0.045; 
        const AFP_COMMISSION_RP = 0.0125;

        let lineChartInstance = null;
        let lastSimulationData = null;

        const TAX_BRACKETS = [
            { limit: 13.5, factor: 0, deduction: 0 },
            { limit: 30, factor: 0.04, deduction: 0.54 },
            { limit: 50, factor: 0.08, deduction: 1.74 },
            { limit: 70, factor: 0.135, deduction: 4.49 },
            { limit: 90, factor: 0.23, deduction: 11.14 },
            { limit: 120, factor: 0.304, deduction: 17.8 },
            { limit: 310, factor: 0.35, deduction: 23.32 },
            { limit: 9999, factor: 0.40, deduction: 38.82 }
        ];

        // --- Helpers de UI ---
        function getCurrencyValue(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            return parseFloat(el.value.replace(/\./g, '').replace(/\s/g, '')) || 0;
        }

        const formatCLP = (num) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(num);
        const formatUF = (num) => new Intl.NumberFormat('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);

        // Notificaciones unificadas según estandard de index
        function showMessage(message, type = 'error') {
            const msgBox = document.getElementById('messageBox');
            const msgText = document.getElementById('messageText');
            const contentBox = document.getElementById('messageBoxContent');
            if (!msgBox || !msgText || !contentBox) return;

            msgText.innerText = message;
            msgBox.classList.remove('hidden');
            
            const themeClass = type === 'error' ? 'bg-red-900/80 border border-red-700/80 text-white' : 'bg-green-900/80 border border-green-700/80 text-acid';
            contentBox.className = `p-4 rounded-xl shadow-xl ${themeClass}`;
            
            setTimeout(() => { msgBox.classList.add('hidden'); }, 4000);
        }

        // --- Validadores ---
        function fnValidaRut(rut) {
            if (!rut || rut.trim().length < 3) return false;
            let tmpRut = rut.replace(/\./g, '').replace(/-/g, '').toUpperCase();
            let v = tmpRut.slice(-1);
            let r = parseInt(tmpRut.slice(0, -1), 10);
            if (isNaN(r)) return false;
            let s = 1, m = 0;
            for (; r; r = Math.floor(r / 10)) s = (s + r % 10 * (9 - m++ % 6)) % 11;
            return (s ? s - 1 : 'K').toString() === v;
        }

        function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
        function validatePhone(phone) { const clean = phone.replace(/\D/g, ""); return clean.length === 9 && clean.startsWith("9"); }

        function updateValidationUI(inputId, isValid, errorMsgId, iconId) {
            const input = document.getElementById(inputId);
            const errorMsg = document.getElementById(errorMsgId);
            const icon = document.getElementById(iconId);
            if (!input || !errorMsg || !icon) return;

            if (isValid) {
                input.classList.remove('border-red-500'); input.classList.add('border-green-500');
                errorMsg.classList.add('hidden');
                icon.innerHTML = '<i data-lucide="check-circle" class="text-green-500 w-5 h-5"></i>';
                icon.classList.remove('hidden');
            } else {
                input.classList.remove('border-green-500'); input.classList.add('border-red-500');
                errorMsg.classList.remove('hidden');
                icon.innerHTML = '<i data-lucide="alert-circle" class="text-red-500 w-5 h-5"></i>';
                icon.classList.remove('hidden');
            }
            if (input.value === "") {
                input.classList.remove('border-red-500', 'border-green-500');
                errorMsg.classList.add('hidden'); icon.classList.add('hidden');
            }
            lucide.createIcons();
        }

        // --- Lógica Actuarial ---
        function calculateTax(amount, utm) {
            const utmVal = amount / utm;
            const b = TAX_BRACKETS.find(x => utmVal <= x.limit);
            return b ? Math.round(Math.max(0, (amount * b.factor) - (b.deduction * utm))) : 0;
        }

        function calculateCNU(age, gender, spouseAge, hasSpouse, rate) {
            const lifeExp = (gender === 'M') ? 86.5 : 91.2; 
            const yearsToLive = Math.max(lifeExp - age, 5);
            let cnu = ((1 - Math.pow(1 + rate, -yearsToLive)) / rate) * 12;
            if (hasSpouse && spouseAge) {
                const ageDiff = age - spouseAge;
                const spouseFactor = 1.12 + (ageDiff * 0.0032); 
                cnu *= spouseFactor;
            } else if (hasSpouse) {
                cnu *= 1.15;
            }
            return cnu;
        }

        function getDetailedPension(rowUF, pgu, uf, utm) {
            const gross = Math.round(rowUF * uf);
            const health = Math.round(gross * 0.07);
            const taxable = gross - health;
            const tax = calculateTax(taxable, utm);
            const liq = taxable - tax + pgu;
            return { uf: rowUF, gross, health, tax, liq };
        }

        async function fetchFinancialIndicators() {
            try {
                const response = await fetch('https://mindicador.cl/api');
                if (response.ok) {
                    const data = await response.json();
                    currentUF = data.uf.valor;
                    currentUTM = data.utm.valor;
                    document.getElementById('navUF').innerText = formatCLP(currentUF);
                    document.getElementById('navUTM').innerText = formatCLP(currentUTM);
                    document.getElementById('navUF').classList.remove('animate-pulse');
                    document.getElementById('navUTM').classList.remove('animate-pulse');
                }
            } catch (e) { 
                document.getElementById('navUF').innerText = formatCLP(defaultUFValue); 
                currentUTM = 66000;
            }
        }

        function runSimulation() {
            const name = document.getElementById('inputName').value.trim();
            const lastName = document.getElementById('inputLastName').value.trim();
            const rut = document.getElementById('inputRut').value;
            const email = document.getElementById('inputEmail').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            const dobInput = document.getElementById('inputDob').value;

            if(!name || !lastName || !fnValidaRut(rut) || !validateEmail(email) || !validatePhone(phone) || !dobInput || !getCurrencyValue('inputBalance')) {
                showMessage("Por favor, revise los datos ingresados.", "error");
                return;
            }

            const ufVal = currentUF;
            const utmVal = currentUTM;
            const age = Math.abs(new Date(Date.now() - new Date(dobInput).getTime()).getUTCFullYear() - 1970);
            const gender = document.getElementById('inputGender').value;
            const hasSpouse = document.getElementById('checkSpouse').checked;
            const spouseDob = document.getElementById('inputSpouseDob').value;
            const spouseAge = spouseDob ? Math.abs(new Date(Date.now() - new Date(spouseDob).getTime()).getUTCFullYear() - 1970) : null;
            
            let capitalTotal = getCurrencyValue('inputBalance') + getCurrencyValue('inputBonoRec') + getCurrencyValue('inputApv');
            const eld = document.getElementById('checkELD').checked ? getCurrencyValue('inputELDAmount') : 0;
            const capitalNeto = capitalTotal - eld;

            const cnuPafe = calculateCNU(age, gender, spouseAge, hasSpouse, RATE_RP);
            const pafeValue = (capitalTotal / ufVal) / cnuPafe * ufVal; 
            
            let pgu = 0;
            const maxPguClp = PGU_FACTOR_MAX_UF * ufVal;
            if (age >= 65 && document.getElementById('inputRSH').value !== '100') {
                if (pafeValue <= PGU_THRESHOLD_FULL_PAFE) pgu = maxPguClp;
                else if (pafeValue < PGU_THRESHOLD_MAX_PAFE) {
                    const factor = (PGU_THRESHOLD_MAX_PAFE - pafeValue) / (PGU_THRESHOLD_MAX_PAFE - PGU_THRESHOLD_FULL_PAFE);
                    pgu = maxPguClp * factor;
                }
            }

            const selected = Array.from(document.querySelectorAll('.sim-check:checked')).map(c => c.value);
            const incPct = (getCurrencyValue('inputIncreasePct') || 100) / 100;
            const garLevels = { 'rv_simple': [1.0, 'Simple Inmediata'], 'rv_gar_120': [0.97, 'Garantizada 10 Años'], 'rv_gar_180': [0.95, 'Garantizada 15 Años'], 'rv_gar_240': [0.93, 'Garantizada 20 Años'] };

            const immRows = [];
            const cnuRV = calculateCNU(age, gender, spouseAge, hasSpouse, RATE_RV);
            Object.keys(garLevels).forEach(key => {
                if(selected.includes(key)) {
                    const rowUF = (capitalNeto / ufVal) / cnuRV * 0.962 * garLevels[key][0];
                    const details = getDetailedPension(rowUF, pgu, ufVal, utmVal);
                    immRows.push({ label: garLevels[key][1], ...details, future: details.liq });
                }
            });

            const incGroups = [];
            const incMonths = [12, 24, 36, 48, 60];
            incMonths.forEach(m => {
                if(selected.includes(`rv_inc_${m}`)) {
                    const rows = [];
                    Object.keys(garLevels).forEach(key => {
                        if(selected.includes(key)) {
                            const modFactor = garLevels[key][0];
                            const baseUF = (capitalNeto / ufVal) / cnuRV * 0.962;
                            const tempUF = baseUF * modFactor * (1 + incPct);
                            const futureUF = baseUF * modFactor * 0.85;
                            const detailsTemp = getDetailedPension(tempUF, pgu, ufVal, utmVal);
                            const detailsFuture = getDetailedPension(futureUF, pgu, ufVal, utmVal);
                            rows.push({ label: `${garLevels[key][1]} (+${incPct*100}%)`, ...detailsTemp, future: detailsFuture.liq, months: m });
                        }
                    });
                    if(rows.length > 0) incGroups.push({ title: `Renta Aumentada (${m} Meses)`, rows });
                }
            });

            const rpRows = [];
            if(selected.includes('rp')) {
                const cnuRP = calculateCNU(age, gender, spouseAge, hasSpouse, RATE_RP);
                const rowUF = (capitalNeto / ufVal) / cnuRP;
                const details = getDetailedPension(rowUF, pgu, ufVal, utmVal);
                const commission = (details.gross - details.health - details.tax) * AFP_COMMISSION_RP;
                details.liq = (details.gross - details.health - details.tax - commission) + pgu;
                rpRows.push({ label: 'Retiro Programado (Año 1)', ...details, future: 0 });
            }

            lastSimulationData = { firstName: name, lastName: lastName, rut, email, phone, capital: capitalTotal, pgu, uf: ufVal, immRows, incGroups, rpRows };
            renderUI(immRows, incGroups, rpRows);
            enviarLeadASheets(lastSimulationData);
            showMessage("Simulación completada con éxito.", "success");
        }

        function renderUI(imm, inc, rp) {
            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultsDashboard').classList.remove('hidden');
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';

            const makeTable = (title, rows) => {
                if(rows.length === 0) return '';
                return `
                <div class="glass-panel overflow-hidden mb-6 border-white/10 rounded-2xl">
                    <div class="bg-oceanLight/50 px-6 py-4 font-serif italic text-lg text-acid border-b border-white/10 flex justify-between items-center">
                        <span>${title}</span>
                        <i data-lucide="layout-grid" class="w-5 h-5 opacity-40"></i>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-[11px] text-right min-w-[650px]">
                            <thead class="bg-oceanDark/40 text-white/50 font-mono uppercase tracking-widest border-b border-white/5">
                                <tr>
                                    <th class="p-4 text-left font-sans">Modalidad</th>
                                    <th class="p-4">UF</th>
                                    <th class="p-4">Salud (CLP)</th>
                                    <th class="p-4">Impuesto (CLP)</th>
                                    <th class="p-4 bg-acid/5 text-acid">Liq. Inicial</th>
                                    <th class="p-4 text-emerald-400">Liq. Futuro</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                ${rows.map(r => `
                                    <tr class="hover:bg-white/5 transition-colors">
                                        <td class="p-4 text-left font-bold text-white border-r border-white/5">${r.label}</td>
                                        <td class="p-4 font-mono text-white/60">${formatUF(r.uf)}</td>
                                        <td class="p-4 font-mono text-red-400/60">-${formatCLP(r.health)}</td>
                                        <td class="p-4 font-mono text-red-400/60">-${formatCLP(r.tax)}</td>
                                        <td class="p-4 font-mono text-acid font-extrabold text-sm bg-acid/5">${formatCLP(r.liq)}</td>
                                        <td class="p-4 font-mono text-emerald-400 font-bold">${r.future > 0 ? formatCLP(r.future) : '<span class="italic text-white/20">Variable</span>'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            };

            container.innerHTML += makeTable('Renta Vitalicia Inmediata', imm);
            inc.forEach(g => container.innerHTML += makeTable(g.title, g.rows));
            container.innerHTML += makeTable('Retiro Programado', rp);
            updateChart(imm, inc, rp);
            lucide.createIcons();
        }

        function updateChart(imm, inc, rp) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if(lineChartInstance) lineChartInstance.destroy();
            const labels = Array.from({length:20}, (_,i) => `Año ${i+1}`);
            const datasets = [];
            if(rp.length) datasets.push({ label: 'Retiro Programado', data: labels.map((_, i) => rp[0].liq * Math.pow(0.97, i)), borderColor: '#94a3b8', borderDash: [5,5], tension: 0.1 });
            if(imm.length) datasets.push({ label: 'RV Simple', data: labels.map(() => imm[0].liq), borderColor: '#CCFF00', borderWidth: 3, tension: 0 });
            inc.forEach((group, index) => {
                const r = group.rows[0];
                const limitYear = Math.ceil(r.months / 12);
                datasets.push({ label: group.title, data: labels.map((_, yearIdx) => (yearIdx < limitYear) ? r.liq : r.future), borderColor: index === 0 ? '#38bdf8' : '#f472b6', borderWidth: 2, stepped: true });
            });
            lineChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', callback: (v) => '$' + (v/1000).toFixed(0) + 'k' } }, x: { ticks: { color: 'rgba(255,255,255,0.4)' } } }, plugins: { legend: { position: 'bottom', labels: { color: 'white', font: { family: 'Space Mono', size: 10 } } } } } });
        }

        async function enviarLeadASheets(data) {
            const API_URL = 'https://sheetdb.io/api/v1/ii1y4lx0ybsjn';
            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        data: [{ 
                            "Fecha": new Date().toLocaleString('es-CL'), 
                            "Nombre": data.firstName, 
                            "Apellido": data.lastName, 
                            "RUT": data.rut, 
                            "Email": data.email, 
                            "Telefono": data.phone, 
                            "Capital": data.capital, 
                            "PGU": data.pgu, 
                            "UF": data.uf 
                        }]
                    }) 
                });
            } catch (e) { console.warn("Lead registration failed"); }
        }

        function generatePDF() {
            if(!lastSimulationData) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.setFillColor(2, 44, 67); doc.rect(0, 0, 297, 20, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text('La Justa - Informe Actuarial Detallado PRO', 15, 14);
            doc.setTextColor(50); doc.setFontSize(10);
            doc.text(`Cliente: ${lastSimulationData.firstName} ${lastSimulationData.lastName} | RUT: ${lastSimulationData.rut}`, 15, 30);
            let allRows = [...lastSimulationData.immRows, ...lastSimulationData.rpRows];
            lastSimulationData.incGroups.forEach(g => allRows.push(...g.rows));
            doc.autoTable({ startY: 40, head: [['Modalidad', 'UF', 'Salud CLP', 'Impuesto CLP', 'Líquido Inicial', 'Líquido Futuro']], body: allRows.map(r => [r.label, formatUF(r.uf), formatCLP(r.health), formatCLP(r.tax), formatCLP(r.liq), r.future > 0 ? formatCLP(r.future) : 'Variable']), headStyles: { fillColor: [2, 44, 67] } });
            doc.save(`LaJusta_${lastSimulationData.rut}.pdf`);
        }

        // --- Listeners UX ---
        document.getElementById('inputRut').addEventListener('input', (e) => {
            let val = e.target.value.replace(/[^0-9kK]/g, "");
            if(val.length > 1) {
                const c = val.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                e.target.value = `${c}-${val.slice(-1).toUpperCase()}`;
            }
        });
        document.getElementById('inputRut').addEventListener('blur', function() { updateValidationUI('inputRut', fnValidaRut(this.value), 'rutErrorMsg', 'rutStatusIcon'); });
        document.getElementById('inputEmail').addEventListener('blur', function() { updateValidationUI('inputEmail', validateEmail(this.value), 'emailErrorMsg', 'emailStatusIcon'); });
        document.getElementById('inputPhone').addEventListener('input', function() { this.value = this.value.replace(/\D/g, ""); });
        document.getElementById('inputPhone').addEventListener('blur', function() { updateValidationUI('inputPhone', validatePhone(this.value), 'phoneErrorMsg', 'phoneStatusIcon'); });
        document.querySelectorAll('.currency-input').forEach(i => i.addEventListener('input', e => { 
            let v = e.target.value.replace(/\D/g, ""); 
            e.target.value = v ? parseInt(v).toLocaleString('es-CL') : ""; 
        }));
        document.getElementById('flagBeneficiaries').addEventListener('change', e => document.getElementById('beneficiariesSection').classList.toggle('hidden', !e.target.checked));
        document.getElementById('checkSpouse').addEventListener('change', e => document.getElementById('spouseDobContainer').classList.toggle('hidden', !e.target.checked));
        document.getElementById('checkELD').addEventListener('change', e => document.getElementById('eldInputContainer').classList.toggle('hidden', !e.target.checked));
        document.getElementById('btnDownloadPDF').addEventListener('click', generatePDF);

        document.addEventListener('DOMContentLoaded', () => { fetchFinancialIndicators(); lucide.createIcons(); });
    </script>
</body>
</html>
