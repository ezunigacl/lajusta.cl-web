<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador La Justa - Motor Actuarial V3 PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ocean: '#022C43', oceanLight: '#053b58', oceanDark: '#011826',
                        acid: '#CCFF00', acidHover: '#b3e600', paper: '#F3F4F6',
                    },
                    fontFamily: {
                        serif: ['"Instrument Serif"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"Space Mono"', 'monospace'], 
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
   
    <style>
        body { background-color: #022C43; color: white; font-family: 'Inter', sans-serif; }
        .grid-bg {
            background-image: linear-gradient(rgba(204, 255, 0, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(204, 255, 0, 0.05) 1px, transparent 1px);
            background-size: 40px 40px; position: fixed; inset: 0; z-index: -1; pointer-events: none;
        }
        .cta-button {
            background-color: var(--tw-colors-acid);
            color: var(--tw-colors-ocean); font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;
            border-radius: 0.25rem; transition: all 0.2s ease; box-shadow: 0 4px 0px 0px #8eb300;
            font-family: var(--tw-font-family-sans);
        }
        .cta-button:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 0px 0px 0px #8eb300; }
        .cta-button:hover:not(:disabled) { filter: brightness(1.1); }
        .cta-button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; background-color: #4b5563; color: #d1d5db; }
        .glass-panel {
            background: rgba(5, 59, 88, 0.4);
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem;
        }
        .text-glow { text-shadow: 0 0 10px rgba(204, 255, 0, 0.4); }
        .input-premium {
            background-color: rgba(5, 59, 88, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #F3F4F6 !important; transition: all 0.2s; width: 100%; padding: 0.5rem; border-radius: 0.375rem;
        }
        .input-premium:focus { border-color: #CCFF00 !important; box-shadow: 0 0 0 1px #CCFF00 !important; outline: none; }
        .input-error { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .input-success { border-color: #22c55e !important; }
        .btn-3d { transition: all 0.1s ease; box-shadow: 4px 4px 0px rgba(0,0,0,0.5); }
        .btn-3d:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.5); }
        
        #ufWidgetContainer input { 
            font-family: 'Space Mono', monospace;
            border-color: transparent !important; 
            background: transparent !important;
            padding: 0 !important;
        }
        #ufWidgetContainer input:focus { border-bottom: 1px solid #CCFF00 !important; }
    </style>
</head>
<body class="antialiased selection:bg-acid selection:text-ocean flex flex-col min-h-screen">

    <div class="grid-bg"></div>

    <!-- Navegación -->
    <nav class="fixed w-full z-50 glass-panel border-b-0 border-white/5 rounded-none top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-6">
                    <a href="index.html" class="flex items-center gap-3 group flex-shrink-0">
                        <div class="h-10 w-10 bg-acid rounded flex items-center justify-center text-ocean font-bold text-xl">L</div>
                        <span class="font-serif text-2xl md:text-3xl text-acid tracking-wide">La Justa<span class="text-white">.</span></span>
                    </a>

                    <div class="hidden lg:flex items-center gap-4 bg-oceanLight/30 border border-white/10 px-4 py-1.5 rounded-lg backdrop-blur-md" id="ufWidgetContainer">
                        <div class="flex flex-col items-start leading-none border-r border-white/10 pr-4">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-0.5 flex gap-2">
                                UF HOY <i onclick="fetchIndicators()" class="ph ph-arrows-clockwise cursor-pointer hover:text-white"></i>
                            </span>
                            <div class="flex items-center">
                                <span class="text-white/60 font-mono mr-1 text-xs">$</span>
                                <input type="text" id="inputUFValue" placeholder="..." class="w-20 text-white text-xs font-bold font-mono focus:outline-none text-left">
                            </div>
                        </div>
                        <div class="flex flex-col items-start leading-none">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-0.5">UTM MES</span>
                            <div class="flex items-center">
                                <span class="text-white/60 font-mono mr-1 text-xs">$</span>
                                <input type="text" id="inputUTMNavbar" disabled placeholder="..." class="w-20 text-white text-xs font-bold font-mono focus:outline-none text-left">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8 font-mono text-sm">
                        <a href="index.html" class="text-white hover:text-acid transition-colors">INICIO</a>
                        <a href="simulador.html" class="text-acid glow-sm border-b border-acid pb-1">SIMULADOR</a>
                        <a href="auditorscomp.html" class="text-white hover:text-acid transition-colors">AUDITOR</a>
                        <a href="index.html#login" class="border border-acid text-acid px-4 py-2 hover:bg-acid hover:text-ocean transition-all btn-3d">ACCESO</a>
                    </div>
                </div>

                <div class="md:hidden">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-white hover:text-acid p-2 focus:outline-none">
                        <i data-lucide="menu" class="w-8 h-8"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-32 lg:pt-40"></div>

    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 mb-20 flex-grow">
        
        <div class="text-center mb-10 fade-in-up">
            <span class="font-mono text-acid text-xs tracking-[0.3em] uppercase mb-2 block">Motor Actuarial V3 PRO</span>
            <h1 class="font-serif text-4xl md:text-5xl text-white mb-4">Simulador de Pensión</h1>
            <p class="text-gray-400 max-w-lg mx-auto text-sm font-sans">
                Algoritmos de precisión normativa basados en Tabla de Mortalidad RV-2023 y Pensión Autofinanciada (PAFE).
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            
            <!-- Sidebar Izquierda (Entradas) -->
            <div class="lg:col-span-4 space-y-8">
                
                <!-- 1. Perfil Personal -->
                <div class="glass-panel shadow-2xl border-paper/10">
                    <div class="p-6 border-b border-paper/20 bg-oceanLight/30 flex items-center gap-3">
                        <span class="bg-acid text-ocean w-7 h-7 rounded-full flex items-center justify-center font-bold text-sm font-mono">1</span>
                        <h2 class="text-xl font-serif italic text-paper uppercase tracking-wide">Perfil Personal</h2>
                    </div>
                    <div class="p-6 space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1">Nombre</label>
                                <input type="text" id="inputName" class="input-premium" placeholder="Ej: Emilia">
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1">Apellido</label>
                                <input type="text" id="inputLastName" class="input-premium" placeholder="Ej: Clarke">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-sans font-bold text-acid uppercase ml-1">RUT</label>
                            <div class="relative">
                                <input type="text" id="inputRut" class="input-premium font-mono" placeholder="12.345.678-9" maxlength="12">
                                <span id="rutStatusIcon" class="absolute right-3 top-2.5 hidden"></span>
                            </div>
                            <p id="rutErrorMsg" class="text-[10px] text-red-400 mt-1 hidden font-bold">RUT Inválido</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1">Email</label>
                                <div class="relative">
                                    <input type="email" id="inputEmail" class="input-premium" placeholder="ejemplo@correo.com">
                                    <span id="emailStatusIcon" class="absolute right-3 top-2.5 hidden"></span>
                                </div>
                                <p id="emailErrorMsg" class="text-[10px] text-red-400 mt-1 hidden font-bold">Email Inválido</p>
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1">Teléfono</label>
                                <div class="relative">
                                    <input type="tel" id="inputPhone" class="input-premium font-mono" placeholder="912345678" maxlength="9">
                                    <span id="phoneStatusIcon" class="absolute right-3 top-2.5 hidden"></span>
                                </div>
                                <p id="phoneErrorMsg" class="text-[10px] text-red-400 mt-1 hidden font-bold">Formato: 9 dígitos (9xxxxxxxx)</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">F. Nacimiento Causante</label>
                                <input type="date" id="inputDob" class="input-premium text-paper/80">
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Género</label>
                                <select id="inputGender" class="input-premium cursor-pointer">
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">AFP Actual</label>
                            <select id="inputAFP" class="input-premium cursor-pointer">
                                <option value="habitat">Habitat</option>
                                <option value="modelo">Modelo</option>
                                <option value="provida">Provida</option>
                                <option value="capital">Capital</option>
                                <option value="cuprum">Cuprum</option>
                                <option value="planvital">PlanVital</option>
                            </select>
                        </div>
                        <div class="bg-emerald-900/20 p-3 rounded border border-emerald-500/30">
                            <label class="text-xs font-sans font-bold text-emerald-400 uppercase ml-1 flex items-center gap-1">
                                <i class="ph ph-money"></i> Promedio Renta (10 años)
                            </label>
                            <div class="relative mt-1">
                                <span class="absolute left-3 top-2.5 text-emerald-500 font-mono">$</span>
                                <input type="text" id="inputAvgSalary" class="input-premium pl-7 font-mono font-bold text-emerald-100 border-emerald-500/30 focus:border-emerald-400 currency-input" placeholder="0">
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 p-3 rounded bg-oceanLight/50 border border-paper/10 cursor-pointer">
                                <input type="checkbox" id="flagBeneficiaries" class="w-4 h-4 rounded text-acid focus:ring-acid border-white/30 bg-oceanLight">
                                <span class="text-xs font-sans font-semibold text-paper uppercase">¿Posee Beneficiarios Legales?</span>
                            </label>
                        </div>
                        <div id="beneficiariesSection" class="hidden pl-4 border-l-2 border-acid/50 space-y-4 bg-oceanLight/20 p-4 rounded-r-lg">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="checkSpouse" class="w-4 h-4 rounded text-acid border-white/30 bg-oceanLight">
                                <span class="text-xs font-sans font-bold text-paper/80">Es Cónyuge / Pareja Civil</span>
                            </label>
                            <div id="spouseDobContainer" class="hidden">
                                <label class="text-[10px] font-sans font-bold text-paper/50 uppercase">Nacimiento Cónyuge</label>
                                <input type="date" id="inputSpouseDob" class="input-premium text-xs py-1">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-sans font-bold text-acid uppercase ml-1 flex items-center gap-1">
                                <i class="ph ph-house-line"></i> Tramo RSH (PGU)
                            </label>
                            <select id="inputRSH" class="input-premium cursor-pointer border-acid/30">
                                <option value="-1">Sin información</option>
                                <option value="90">0% - 90% (Califica)</option>
                                <option value="100">91% - 100% (No califica)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 2. Patrimonio -->
                <div class="glass-panel shadow-2xl border-paper/10 shadow-oceanLight/50">
                    <div class="p-6 border-b border-paper/20 bg-oceanLight/30 flex items-center gap-3">
                        <span class="bg-acid text-ocean w-7 h-7 rounded-full flex items-center justify-center font-bold text-sm font-mono">2</span>
                        <h2 class="text-xl font-serif italic text-paper uppercase tracking-wide">Patrimonio</h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-oceanLight/50 p-4 rounded-xl border border-paper/10 space-y-4">
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1 flex items-center gap-1"><i class="ph ph-wallet text-acid"></i> Saldo CCI (AFP)</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-2.5 text-white/50 font-mono">$</span>
                                    <input type="text" id="inputBalance" class="input-premium pl-7 font-mono font-bold text-acid text-glow currency-input" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Bono Reconocimiento</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-2.5 text-white/50 font-mono">$</span>
                                    <input type="text" id="inputBonoRec" class="input-premium pl-7 font-mono text-paper/80 currency-input" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Saldo APV</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-2.5 text-white/50 font-mono">$</span>
                                    <input type="text" id="inputApv" class="input-premium pl-7 font-mono text-paper/80 currency-input" placeholder="0">
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-900/10 p-4 rounded-xl border border-purple-500/20 space-y-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="checkELD" class="w-4 h-4 rounded text-purple-400 border-white/30 bg-oceanLight">
                                <span class="text-sm font-sans font-bold text-purple-300 uppercase">Retirar Excedente (ELD)</span>
                            </label>
                            <div id="eldInputContainer" class="hidden mt-2 relative">
                                <label class="text-[10px] font-sans text-purple-300 font-bold block mb-1">Monto a Retirar</label>
                                <span class="absolute left-3 top-6 text-purple-500 font-mono text-sm">$</span>
                                <input type="text" id="inputELDAmount" class="input-premium pl-7 font-mono text-purple-200 currency-input" placeholder="0">
                            </div>
                        </div>
                        <div class="bg-sky-900/10 p-4 rounded-xl border border-sky-500/20">
                             <label class="text-xs font-sans font-bold text-sky-400 uppercase ml-1 flex items-center gap-1">
                                <i class="ph ph-clock-countdown"></i> Años Cotizados
                             </label>
                             <input type="number" id="inputYearsQuoted" class="input-premium mt-1 border-sky-900/50 focus:border-sky-500" placeholder="Ej: 25">
                        </div>
                    </div>
                </div>

                <!-- 3. Configuración -->
                <div class="glass-panel shadow-2xl shadow-acid/20 border-acid/30 relative">
                    <div class="absolute top-0 left-0 w-1 h-full bg-acid"></div>
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-5">
                            <i class="ph ph-sliders text-acid text-2xl"></i>
                            <h2 class="text-xl font-serif italic text-paper uppercase tracking-wide">Configuración</h2>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex flex-col gap-1 p-3 rounded bg-oceanLight/50 border border-paper/10 hover:border-acid/50 transition-colors cursor-pointer">
                                    <input type="checkbox" class="sim-check rounded text-acid focus:ring-acid border-white/30 bg-oceanLight/80 w-4 h-4" value="rp" checked>
                                    <span class="text-xs font-sans font-bold text-paper mt-1">RETIRO PROGRAMADO</span>
                                </label>
                                <label class="flex flex-col gap-1 p-3 rounded bg-oceanLight/50 border border-acid/30 hover:border-acid transition-colors cursor-pointer">
                                    <input type="checkbox" class="sim-check rounded text-acid focus:ring-acid border-acid/50 bg-oceanLight/80 w-4 h-4" value="rv_simple" checked>
                                    <span class="text-xs font-sans font-bold text-acid mt-1">RENTA VITALICIA</span>
                                </label>
                            </div>
                            <div>
                                <span class="text-[10px] font-sans font-bold text-paper/60 uppercase tracking-wide">Periodos Garantizados RV</span>
                                <div class="grid grid-cols-2 gap-2 mt-2 bg-oceanLight/30 p-3 rounded">
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_gar_120" checked><span class="text-xs text-paper/80 font-mono">120m</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_gar_180" checked><span class="text-xs text-paper/80 font-mono">180m</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_gar_240" checked><span class="text-xs text-paper/80 font-mono">240m</span></label>
                                    <label class="flex items-center gap-2 p-1 border border-dashed border-paper/20 rounded bg-oceanLight/20">
                                        <input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" id="checkCustomGar">
                                        <span class="text-xs font-sans text-paper/80">Otro:</span>
                                        <input type="number" id="inputCustomGarMonths" class="w-12 text-xs bg-oceanLight text-paper/80 rounded px-1 focus:outline-none" placeholder="Mes" disabled>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-acid/10 p-4 rounded-lg border border-acid/30">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-sm font-sans font-bold text-acid uppercase tracking-wide flex items-center gap-2">
                                        <i class="ph ph-lightning-fill"></i> Renta Aumentada
                                    </span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="inputIncreasePct" value="100" class="w-14 text-right text-sm font-mono bg-oceanLight/50 border border-acid/30 rounded px-2 text-acid focus:ring-acid" min="1" max="100">
                                        <span class="text-sm text-acid">%</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_12" checked><span class="text-[10px] text-paper/80">12m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_24" checked><span class="text-[10px] text-paper/80">24m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_36"><span class="text-[10px] text-paper/80">36m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_48"><span class="text-[10px] text-paper/80">48m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_60"><span class="text-[10px] text-paper/80">60m</span></label>
                                    <label class="flex items-center gap-1 col-span-1 p-1 border border-dashed border-paper/20 rounded bg-oceanLight/20 w-full">
                                        <input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" id="checkCustomInc">
                                        <span class="text-[9px] text-paper/80 mr-1">Otro:</span>
                                        <input type="number" id="inputCustomIncMonths" class="w-full text-xs border border-white/20 bg-oceanLight text-paper/80 rounded px-1 focus:outline-none focus:border-acid" placeholder="Mes" disabled>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="btnSimulate" onclick="runSimulation()" class="cta-button w-full py-4 text-lg flex justify-center items-center gap-2">
                    <span>Simular Pensión</span>
                    <i class="ph ph-rocket font-bold"></i>
                </button>
            </div>

            <!-- Right Content (Resultados) -->
            <div class="lg:col-span-8 space-y-10">
                <div id="placeholderState" class="h-full min-h-[500px] flex flex-col items-center justify-center glass-panel rounded-3xl p-12 text-center border-dashed border-paper/20 border-2">
                    <div class="w-24 h-24 bg-oceanLight/50 rounded-full flex items-center justify-center mb-6 animate-pulse text-acid ring-4 ring-acid/20">
                        <i class="ph ph-chart-line-up text-5xl"></i>
                    </div>
                    <h3 class="text-3xl font-serif italic font-bold text-paper mb-2">Análisis Actuarial V3 PRO</h3>
                    <p class="text-white/70 text-base max-w-sm mx-auto">Ingresa tus datos y presiona **Simular** para desplegar el informe de proyección profesional.</p>
                </div>

                <div id="resultsDashboard" class="hidden space-y-10 animate-fade-in-up">
                    <div class="flex justify-between items-center bg-oceanDark/40 p-4 rounded-xl border border-white/5">
                        <h1 class="text-2xl font-serif italic text-paper">Proyección de Modalidades</h1>
                        <button id="btnDownloadPDF" class="cta-button bg-oceanLight text-acid py-2 px-4 text-xs flex items-center gap-2" style="box-shadow: 0 4px 0px 0px #022C43;">
                            <i class="ph ph-file-pdf text-lg"></i> EXPORTAR INFORME DETALLADO (PDF)
                        </button>
                    </div>
                    
                    <div id="tablesContainer" class="space-y-8"></div>

                    <div class="glass-panel p-8 shadow-2xl border-white/5">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-serif italic text-paper uppercase tracking-wide">Flujo de Caja Mensual Proyectado</h3>
                                <p class="text-xs text-white/40 font-mono mt-1">Simulación a 20 años bajo parámetros normativos SP.</p>
                            </div>
                        </div>
                        <div class="chart-container" style="position: relative; height:450px; width:100%">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-notification" class="fixed top-5 right-5 z-50 hidden transition-all duration-300 transform translate-y-[-20px] opacity-0">
        <div id="toast-content" class="flex items-center w-full max-w-xs p-4 glass-panel rounded-lg shadow-xl" role="alert">
            <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
            <div class="ml-3 text-sm font-sans font-medium" id="toast-message"></div>
        </div>
    </div>

    <script>
        // --- Constantes Actuariales Normativas PRO ---
        const PGU_FACTOR_MAX_UF = 5.64;
        const PGU_THRESHOLD_FULL_PAFE = 729530; 
        const PGU_THRESHOLD_MAX_PAFE = 1158355; 
        
        const RATE_RP = 0.0341; 
        const RATE_RV = 0.0325; 
        const RATE_FONDO_C = 0.045; 
        
        let currentUF = 38000;
        let currentUTM = 66000;
        let lineChartInstance = null;
        let lastSimulationData = null;

        const TAX_BRACKETS = [
            { limit: 13.5, factor: 0, deduction: 0 },
            { limit: 30, factor: 0.04, deduction: 0.54 },
            { limit: 50, factor: 0.08, deduction: 1.74 },
            { limit: 70, factor: 0.135, deduction: 4.49 },
            { limit: 90, factor: 0.23, deduction: 11.14 },
            { limit: 120, factor: 0.304, deduction: 17.8 },
            { limit: 310, factor: 0.35, deduction: 23.32 },
            { limit: 9999, factor: 0.40, deduction: 38.82 }
        ];

        // --- Helper: getCurrencyValue para limpieza de moneda ---
        function getCurrencyValue(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const v = el.value;
            // Elimina puntos de miles y espacios, luego convierte a número
            return v ? parseFloat(v.replace(/\./g, '').replace(/\s/g, '')) : 0;
        }

        // --- Validadores de UX en Tiempo Real ---
        function fnValidaRut(rut) {
            if (!rut || rut.trim().length < 3) return false;
            let tmpRut = rut.replace(/\./g, '').replace(/-/g, '').toUpperCase();
            let v = tmpRut.slice(-1);
            let r = parseInt(tmpRut.slice(0, -1), 10);
            if (isNaN(r)) return false;
            let s = 1, m = 0;
            for (; r; r = Math.floor(r / 10)) s = (s + r % 10 * (9 - m++ % 6)) % 11;
            return (s ? s - 1 : 'K').toString() === v;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(phone) {
            const cleanPhone = phone.replace(/\D/g, "");
            return cleanPhone.length === 9 && cleanPhone.startsWith("9");
        }

        function updateValidationUI(inputId, isValid, errorMsgId, iconId) {
            const input = document.getElementById(inputId);
            const errorMsg = document.getElementById(errorMsgId);
            const icon = document.getElementById(iconId);
            if (isValid) {
                input.classList.remove('input-error', 'border-red-500');
                input.classList.add('input-success', 'border-green-500');
                errorMsg.classList.add('hidden');
                icon.innerHTML = '<i class="ph ph-check-circle text-green-500 text-lg"></i>';
                icon.classList.remove('hidden');
            } else {
                input.classList.remove('input-success', 'border-green-500');
                input.classList.add('input-error', 'border-red-500');
                errorMsg.classList.remove('hidden');
                icon.innerHTML = '<i class="ph ph-warning-circle text-red-500 text-lg"></i>';
                icon.classList.remove('hidden');
            }
            if (input.value === "") {
                input.classList.remove('input-error', 'input-success', 'border-red-500', 'border-green-500');
                errorMsg.classList.add('hidden');
                icon.classList.add('hidden');
            }
        }

        // --- Utils de Formato ---
        const formatCLP = (num) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(num);
        const formatUF = (num) => new Intl.NumberFormat('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');
            msgEl.textContent = message;
            iconEl.className = `inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg ${type === 'error' ? 'text-red-500 bg-red-100' : 'text-acid bg-oceanLight/50'}`;
            iconEl.innerHTML = type === 'error' ? '<i class="ph ph-warning-circle text-xl"></i>' : '<i class="ph ph-check-circle text-xl"></i>';
            toast.classList.remove('hidden', 'translate-y-[-20px]', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => { toast.classList.remove('translate-y-0', 'opacity-100'); toast.classList.add('translate-y-[-20px]', 'opacity-0'); setTimeout(() => toast.classList.add('hidden'), 300); }, 4000);
        }

        async function fetchIndicators() {
            try {
                const response = await fetch('https://mindicador.cl/api');
                const data = await response.json();
                currentUF = data.uf.valor;
                currentUTM = data.utm.valor;
                document.getElementById('inputUFValue').value = formatUF(currentUF);
                document.getElementById('inputUTMNavbar').value = formatCLP(currentUTM);
            } catch (e) { console.error("API Error", e); }
        }

        // --- Motor de Cálculo Actuarial PRO ---
        function calculateTax(amount) {
            const utmVal = amount / currentUTM;
            const b = TAX_BRACKETS.find(x => utmVal <= x.limit);
            return b ? Math.round(Math.max(0, (amount * b.factor) - (b.deduction * currentUTM))) : 0;
        }

        function calculateCNU(age, gender, spouseAge, hasSpouse, rate) {
            const lifeExp = (gender === 'M') ? 86.5 : 91.2; 
            const yearsToLive = Math.max(lifeExp - age, 5);
            let cnu = ((1 - Math.pow(1 + rate, -yearsToLive)) / rate) * 12;
            if (hasSpouse && spouseAge) {
                const ageDiff = age - spouseAge;
                const spouseFactor = 1.12 + (ageDiff * 0.0032); 
                cnu *= spouseFactor;
            } else if (hasSpouse) {
                cnu *= 1.15;
            }
            return cnu;
        }

        function getDetailedPension(rowUF, pgu, uf) {
            const gross = Math.round(rowUF * uf);
            const health = Math.round(gross * 0.07);
            const taxable = gross - health;
            const tax = calculateTax(taxable);
            const liq = taxable - tax + pgu;
            return { uf: rowUF, gross, health, tax, liq };
        }

        function runSimulation() {
            const name = document.getElementById('inputName').value.trim();
            const lastName = document.getElementById('inputLastName').value.trim();
            const rut = document.getElementById('inputRut').value;
            const email = document.getElementById('inputEmail').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            const dobInput = document.getElementById('inputDob').value;

            if(!name || !lastName || !fnValidaRut(rut) || !validateEmail(email) || !validatePhone(phone) || !dobInput || !getCurrencyValue('inputBalance')) {
                showToast("Por favor, revise los datos ingresados", "error");
                return;
            }

            const ufVal = currentUF || 38000;
            const age = Math.abs(new Date(Date.now() - new Date(dobInput).getTime()).getUTCFullYear() - 1970);
            const gender = document.getElementById('inputGender').value;
            const hasSpouse = document.getElementById('checkSpouse').checked;
            const spouseDob = document.getElementById('inputSpouseDob').value;
            const spouseAge = spouseDob ? Math.abs(new Date(Date.now() - new Date(spouseDob).getTime()).getUTCFullYear() - 1970) : null;
            
            let capitalTotal = getCurrencyValue('inputBalance') + getCurrencyValue('inputBonoRec') + getCurrencyValue('inputApv');
            const eld = document.getElementById('checkELD').checked ? getCurrencyValue('inputELDAmount') : 0;
            const capitalNeto = capitalTotal - eld;

            const cnuPafe = calculateCNU(age, gender, spouseAge, hasSpouse, RATE_RP);
            const pafeValue = (capitalTotal / ufVal) / cnuPafe * ufVal; 
            
            let pgu = 0;
            const maxPguClp = PGU_FACTOR_MAX_UF * ufVal;
            if (age >= 65 && document.getElementById('inputRSH').value !== '100') {
                if (pafeValue <= PGU_THRESHOLD_FULL_PAFE) pgu = maxPguClp;
                else if (pafeValue < PGU_THRESHOLD_MAX_PAFE) {
                    const factor = (PGU_THRESHOLD_MAX_PAFE - pafeValue) / (PGU_THRESHOLD_MAX_PAFE - PGU_THRESHOLD_FULL_PAFE);
                    pgu = maxPguClp * factor;
                }
            }

            const selected = Array.from(document.querySelectorAll('.sim-check:checked')).map(c => c.value);
            // inputIncreasePct es un input number nativo, getCurrencyValue funciona igual
            const incPct = (getCurrencyValue('inputIncreasePct') || 100) / 100;
            const garLevels = { 'rv_simple': [1.0, 'Simple Inmediata'], 'rv_gar_120': [0.97, 'Garantizada 10 Años'], 'rv_gar_180': [0.95, 'Garantizada 15 Años'], 'rv_gar_240': [0.93, 'Garantizada 20 Años'] };

            const immRows = [];
            const cnuRV = calculateCNU(age, gender, spouseAge, hasSpouse, RATE_RV);
            Object.keys(garLevels).forEach(key => {
                if(selected.includes(key)) {
                    const rowUF = (capitalNeto / ufVal) / cnuRV * 0.962 * garLevels[key][0];
                    const details = getDetailedPension(rowUF, pgu, ufVal);
                    immRows.push({ label: garLevels[key][1], ...details, future: details.liq });
                }
            });

            const incGroups = [];
            const incMonths = [12, 24, 36, 48, 60];
            incMonths.forEach(m => {
                if(selected.includes(`rv_inc_${m}`)) {
                    const rows = [];
                    Object.keys(garLevels).forEach(key => {
                        if(selected.includes(key)) {
                            const modFactor = garLevels[key][0];
                            const baseUF = (capitalNeto / ufVal) / cnuRV * 0.962;
                            const tempUF = baseUF * modFactor * (1 + incPct);
                            const futureUF = baseUF * modFactor * 0.85;
                            const detailsTemp = getDetailedPension(tempUF, pgu, ufVal);
                            const detailsFuture = getDetailedPension(futureUF, pgu, ufVal);
                            rows.push({ label: `${garLevels[key][1]} (+${incPct*100}%)`, ...detailsTemp, future: detailsFuture.liq, months: m });
                        }
                    });
                    if(rows.length > 0) incGroups.push({ title: `Renta Aumentada (${m} Meses)`, rows });
                }
            });

            const rpRows = [];
            if(selected.includes('rp')) {
                const cnuRP = calculateCNU(age, gender, spouseAge, hasSpouse, RATE_RP);
                const rowUF = (capitalNeto / ufVal) / cnuRP;
                const details = getDetailedPension(rowUF, pgu, ufVal);
                const commission = (details.gross - details.health - details.tax) * 0.0125;
                details.liq = (details.gross - details.health - details.tax - commission) + pgu;
                rpRows.push({ label: 'Retiro Programado (Año 1)', ...details, future: 0 });
            }

            lastSimulationData = { 
                firstName: name,
                lastName: lastName,
                rut, 
                email, 
                phone, 
                capital: capitalTotal, 
                pgu, 
                uf: ufVal, 
                immRows, 
                incGroups, 
                rpRows 
            };
            renderUI(immRows, incGroups, rpRows);
            enviarLeadASheets(lastSimulationData);
            showToast("Simulación completada con éxito", "success");
        }

        function renderUI(imm, inc, rp) {
            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultsDashboard').classList.remove('hidden');
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';

            const makeTable = (title, rows) => {
                if(rows.length === 0) return '';
                return `
                <div class="glass-panel overflow-hidden mb-6 border-white/5">
                    <div class="bg-oceanLight/50 px-6 py-3 font-bold text-acid border-b border-white/10 uppercase tracking-widest text-xs flex justify-between items-center">
                        <span>${title}</span>
                        <i class="ph ph-table text-lg opacity-40"></i>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-right min-w-[600px]">
                            <thead class="bg-white/5 text-paper/70 font-mono uppercase tracking-tighter">
                                <tr>
                                    <th class="p-4 text-left font-sans">Modalidad</th>
                                    <th class="p-4">UF</th>
                                    <th class="p-4">Salud (CLP)</th>
                                    <th class="p-4">Impuesto (CLP)</th>
                                    <th class="p-4 bg-acid/5">Liq. Inicial</th>
                                    <th class="p-4 text-emerald-400">Liq. Futuro</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                ${rows.map(r => `
                                    <tr class="hover:bg-white/5 transition-colors">
                                        <td class="p-4 text-left font-bold text-white border-r border-white/5">${r.label}</td>
                                        <td class="p-4 font-mono text-paper/60">${formatUF(r.uf)}</td>
                                        <td class="p-4 font-mono text-red-400/80">-${formatCLP(r.health)}</td>
                                        <td class="p-4 font-mono text-red-400/80">-${formatCLP(r.tax)}</td>
                                        <td class="p-4 font-mono text-acid font-extrabold text-base bg-acid/5">${formatCLP(r.liq)}</td>
                                        <td class="p-4 font-mono text-emerald-400 font-bold">${r.future > 0 ? formatCLP(r.future) : '<span class="italic text-white/20">Variable</span>'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            };

            container.innerHTML += makeTable('Renta Vitalicia Inmediata', imm);
            inc.forEach(g => container.innerHTML += makeTable(g.title, g.rows));
            container.innerHTML += makeTable('Retiro Programado', rp);
            updateChart(imm, inc, rp);
        }

        function updateChart(imm, inc, rp) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if(lineChartInstance) lineChartInstance.destroy();
            const labels = Array.from({length:20}, (_,i) => `Año ${i+1}`);
            const datasets = [];
            if(rp.length) datasets.push({ label: 'Retiro Programado', data: labels.map((_, i) => rp[0].liq * Math.pow(0.97, i)), borderColor: '#94a3b8', borderDash: [5,5], tension: 0.1 });
            if(imm.length) datasets.push({ label: 'RV Simple', data: labels.map(() => imm[0].liq), borderColor: '#CCFF00', borderWidth: 3, tension: 0 });
            inc.forEach((group, index) => {
                const r = group.rows[0];
                const limitYear = Math.ceil(r.months / 12);
                datasets.push({ label: group.title, data: labels.map((_, yearIdx) => (yearIdx < limitYear) ? r.liq : r.future), borderColor: index === 0 ? '#38bdf8' : '#f472b6', borderWidth: 2, stepped: true });
            });
            lineChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', callback: (v) => '$' + (v/1000).toFixed(0) + 'k' } }, x: { ticks: { color: 'rgba(255,255,255,0.4)' } } }, plugins: { legend: { position: 'bottom', labels: { color: 'white', font: { family: 'Space Mono' } } } } } });
        }

        // --- Registro de Leads en Google Sheets vía SheetDB ---
        async function enviarLeadASheets(data) {
            const API_URL = 'https://sheetdb.io/api/v1/ii1y4lx0ybsjn';
            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        data: [{ 
                            "Fecha": new Date().toLocaleString('es-CL'), 
                            "Nombre": data.firstName, 
                            "Apellido": data.lastName, 
                            "RUT": data.rut, 
                            "Email": data.email, 
                            "Telefono": data.phone, 
                            "Capital": data.capital, 
                            "PGU": data.pgu, 
                            "UF": data.uf 
                        }]
                    }) 
                });
            } catch (e) { console.warn("Registro de Lead fallido"); }
        }

        function generatePDF() {
            if(!lastSimulationData) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.setFillColor(2, 44, 67); doc.rect(0, 0, 297, 20, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text('La Justa - Informe Actuarial Detallado PRO', 15, 14);
            doc.setTextColor(50); doc.setFontSize(10);
            doc.text(`Cliente: ${lastSimulationData.firstName} ${lastSimulationData.lastName} | RUT: ${lastSimulationData.rut}`, 15, 30);
            let allRows = [...lastSimulationData.immRows, ...lastSimulationData.rpRows];
            lastSimulationData.incGroups.forEach(g => allRows.push(...g.rows));
            doc.autoTable({ startY: 40, head: [['Modalidad', 'UF', 'Salud CLP', 'Impuesto CLP', 'Líquido Inicial', 'Líquido Futuro']], body: allRows.map(r => [r.label, formatUF(r.uf), formatCLP(r.health), formatCLP(r.tax), formatCLP(r.liq), r.future > 0 ? formatCLP(r.future) : 'Variable']), headStyles: { fillColor: [2, 44, 67] } });
            doc.save(`LaJusta_${lastSimulationData.rut}.pdf`);
        }

        // --- Listeners UX ---
        document.getElementById('inputRut').addEventListener('input', (e) => {
            let val = e.target.value.replace(/[^0-9kK]/g, "");
            if(val.length > 1) {
                const c = val.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                e.target.value = `${c}-${val.slice(-1).toUpperCase()}`;
            }
        });
        document.getElementById('inputRut').addEventListener('blur', function() { updateValidationUI('inputRut', fnValidaRut(this.value), 'rutErrorMsg', 'rutStatusIcon'); });
        document.getElementById('inputEmail').addEventListener('blur', function() { updateValidationUI('inputEmail', validateEmail(this.value), 'emailErrorMsg', 'emailStatusIcon'); });
        document.getElementById('inputPhone').addEventListener('input', function() { this.value = this.value.replace(/\D/g, ""); });
        document.getElementById('inputPhone').addEventListener('blur', function() { updateValidationUI('inputPhone', validatePhone(this.value), 'phoneErrorMsg', 'phoneStatusIcon'); });
        document.querySelectorAll('.currency-input').forEach(i => i.addEventListener('input', e => { 
            let v = e.target.value.replace(/\D/g, ""); 
            e.target.value = v ? parseInt(v).toLocaleString('es-CL') : ""; 
        }));
        document.getElementById('flagBeneficiaries').addEventListener('change', e => document.getElementById('beneficiariesSection').classList.toggle('hidden', !e.target.checked));
        document.getElementById('checkSpouse').addEventListener('change', e => document.getElementById('spouseDobContainer').classList.toggle('hidden', !e.target.checked));
        document.getElementById('checkELD').addEventListener('change', e => document.getElementById('eldInputContainer').classList.toggle('hidden', !e.target.checked));
        document.getElementById('checkCustomGar').addEventListener('change', e => document.getElementById('inputCustomGarMonths').disabled = !e.target.checked);
        document.getElementById('checkCustomInc').addEventListener('change', e => document.getElementById('inputCustomIncMonths').disabled = !e.target.checked);
        document.getElementById('btnDownloadPDF').addEventListener('click', generatePDF);

        window.onload = fetchIndicators;
    </script>
</body>
</html>
