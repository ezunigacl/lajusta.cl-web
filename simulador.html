<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador La Justa - Motor Actuarial V3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ocean: '#022C43', oceanLight: '#053b58', oceanDark: '#011826',
                        acid: '#CCFF00', acidHover: '#b3e600', paper: '#F3F4F6',
                    },
                    fontFamily: {
                        serif: ['"Instrument Serif"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"Space Mono"', 'monospace'], 
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #022C43; color: white; font-family: 'Inter', sans-serif; }
        .grid-bg {
            background-image: linear-gradient(rgba(204, 255, 0, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(204, 255, 0, 0.05) 1px, transparent 1px);
            background-size: 40px 40px; position: fixed; inset: 0; z-index: -1; pointer-events: none;
        }
        .cta-button {
            background-color: var(--tw-colors-acid); color: var(--tw-colors-ocean); font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;
            border-radius: 0.25rem; transition: all 0.2s ease; box-shadow: 0 4px 0px 0px #8eb300; font-family: var(--tw-font-family-sans);
        }
        .cta-button:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 0px 0px 0px #8eb300; }
        .cta-button:hover:not(:disabled) { filter: brightness(1.1); }
        .cta-button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; background-color: #4b5563; color: #d1d5db; }
        .glass-panel {
            background: rgba(5, 59, 88, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem;
        }
        .text-glow { text-shadow: 0 0 10px rgba(204, 255, 0, 0.4); }
        .input-premium {
            background-color: rgba(5, 59, 88, 0.2) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #F3F4F6 !important; transition: all 0.2s; width: 100%; padding: 0.5rem; border-radius: 0.375rem;
        }
        .input-premium:focus { border-color: #CCFF00 !important; box-shadow: 0 0 0 1px #CCFF00 !important; outline: none; }
        .input-error { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .table-row-hover:hover td { background-color: rgba(204, 255, 0, 0.05); }
        .btn-3d { transition: all 0.1s ease; box-shadow: 4px 4px 0px rgba(0,0,0,0.5); }
        .btn-3d:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.5); }
        
        /* Ajuste para inputs del header */
        #ufWidgetContainer input { 
            font-family: 'Space Mono', monospace; 
            border-color: transparent !important; 
            background: transparent !important;
            padding: 0 !important;
        }
        #ufWidgetContainer input:focus { border-bottom: 1px solid #CCFF00 !important; }
    </style>
</head>
<body class="antialiased selection:bg-acid selection:text-ocean flex flex-col min-h-screen">

    <div class="grid-bg"></div>

    <nav class="fixed w-full z-50 glass-panel border-b-0 border-white/5 rounded-none top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-6">
                    <a href="index.html" class="flex items-center gap-3 group flex-shrink-0">
                        <img src="Logo.jpg" alt="Logo" class="h-10 w-10 rounded-lg border border-white/10 group-hover:border-acid transition-colors object-cover">
                        <span class="font-serif text-2xl md:text-3xl text-acid tracking-wide">La Justa<span class="text-white">.</span></span>
                    </a>

                    <div class="hidden lg:flex items-center gap-4 bg-oceanLight/30 border border-white/10 px-4 py-1.5 rounded-lg backdrop-blur-md" id="ufWidgetContainer">
                        <div class="flex flex-col items-start leading-none border-r border-white/10 pr-4">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-0.5 flex gap-2">
                                UF HOY <i onclick="fetchIndicators()" class="ph ph-arrows-clockwise cursor-pointer hover:text-white"></i>
                            </span>
                            <div class="flex items-center">
                                <span class="text-white/60 font-mono mr-1 text-xs">$</span>
                                <input type="text" id="inputUFValue" placeholder="..." class="w-20 text-white text-xs font-bold font-mono focus:outline-none text-left">
                            </div>
                        </div>
                        <div class="flex flex-col items-start leading-none">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-0.5">UTM MES</span>
                            <div class="flex items-center">
                                <span class="text-white/60 font-mono mr-1 text-xs">$</span>
                                <input type="text" id="inputUTMNavbar" disabled placeholder="..." class="w-20 text-white text-xs font-bold font-mono focus:outline-none text-left">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8 font-mono text-sm">
                        <a href="index.html" class="text-white hover:text-acid transition-colors">INICIO</a>
                        <a href="index.html#que-hacemos" class="text-white hover:text-acid transition-colors">SERVICIOS</a>
                        <a href="simulador.html" class="text-acid glow-sm border-b border-acid pb-1">SIMULADOR</a>
                        <a href="auditorscomp.html" class="text-white hover:text-acid transition-colors">AUDITOR</a>
                        <a href="rentaprivada.html" class="text-white hover:text-acid transition-colors">RENTA</a>
                        <a href="index.html#login" class="border border-acid text-acid px-4 py-2 hover:bg-acid hover:text-ocean transition-all btn-3d">ACCESO</a>
                    </div>
                </div>

                <div class="md:hidden">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-white hover:text-acid p-2 focus:outline-none">
                        <i data-lucide="menu" class="w-8 h-8"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="mobile-menu" class="hidden md:hidden bg-oceanDark/95 backdrop-blur-xl border-t border-white/10 absolute w-full left-0">
            <div class="px-4 pt-2 pb-6 space-y-2 font-mono text-sm">
                <a href="index.html" class="block px-3 py-4 text-white hover:text-acid border-b border-white/5">INICIO</a>
                <a href="simulador.html" class="block px-3 py-4 text-acid font-bold border-b border-white/5">SIMULADOR</a>
                <a href="auditorscomp.html" class="block px-3 py-4 text-white hover:text-acid border-b border-white/5">AUDITOR SCOMP</a>
                <a href="rentaprivada.html" class="block px-3 py-4 text-white hover:text-acid border-b border-white/5">RENTA PRIVADA</a>
                <a href="eld.html" class="block px-3 py-4 text-white hover:text-acid border-b border-white/5">EFICIENCIA ELD</a>
                <a href="index.html#login" class="block px-3 py-4 text-acid font-bold">ACCESO</a>
            </div>
        </div>
    </nav>

    <div class="pt-32 lg:pt-40"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 mb-20 flex-grow">
        <div class="text-center mb-10 fade-in-up">
            <span class="font-mono text-acid text-xs tracking-[0.3em] uppercase mb-2 block">Motor Actuarial V3</span>
            <h1 class="font-serif text-4xl md:text-5xl text-white mb-4">Simulador de Pensión</h1>
            <p class="text-gray-400 max-w-lg mx-auto text-sm font-sans">
                Proyección matemática basada en interés compuesto y tablas de mortalidad ajustadas.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            
            <div class="lg:col-span-4 space-y-8">
                
                <div class="glass-panel shadow-2xl border-paper/10 shadow-oceanLight/50">
                    <div class="p-6 border-b border-paper/20 bg-oceanLight/30 flex items-center gap-3">
                        <span class="bg-acid text-ocean w-7 h-7 rounded-full flex items-center justify-center font-bold text-sm font-mono">1</span>
                        <h2 class="text-xl font-serif italic text-paper uppercase tracking-wide">Perfil Personal</h2>
                    </div>
                    <div class="p-6 space-y-5">
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1">Nombre</label>
                                <input type="text" id="inputName" class="input-premium" placeholder="Ej: Emilia Clarke">
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1">RUT</label>
                                <div class="relative">
                                    <input type="text" id="inputRut" class="input-premium font-mono" placeholder="12.345.678-9" maxlength="12">
                                    <span id="rutStatusIcon" class="absolute right-3 top-2.5 hidden"></span>
                                </div>
                                <p id="rutErrorMsg" class="text-[10px] text-red-400 mt-1 hidden font-bold">RUT Inválido</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">F. Nacimiento</label>
                                    <input type="date" id="inputDob" class="input-premium text-paper/80">
                                </div>
                                <div>
                                    <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Género</label>
                                    <select id="inputGender" class="input-premium cursor-pointer">
                                        <option value="M">Masculino</option>
                                        <option value="F">Femenino</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">AFP Actual</label>
                                    <select id="inputAFP" class="input-premium cursor-pointer">
                                        <option value="habitat">Habitat</option>
                                        <option value="modelo">Modelo</option>
                                        <option value="planvital">PlanVital</option>
                                        <option value="provida">Provida</option>
                                        <option value="capital">Capital</option>
                                        <option value="cuprum">Cuprum</option>
                                        <option value="uno">Uno</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Tipo Pensión</label>
                                    <select id="inputPensionType" class="input-premium cursor-pointer">
                                        <option value="vejez_edad">Vejez Edad</option>
                                        <option value="vejez_anticipada">Vejez Anticipada</option>
                                        <option value="invalidez_total">Invalidez Total</option>
                                        <option value="invalidez_parcial">Invalidez Parcial</option>
                                        <option value="sobrevivencia">Sobrevivencia</option>
                                    </select>
                                </div>
                            </div>
                            <div id="salaryContainer" class="bg-emerald-900/20 p-3 rounded border border-emerald-500/30">
                                <label class="text-xs font-sans font-bold text-emerald-400 uppercase ml-1 flex items-center gap-1">
                                    <i class="ph ph-money"></i> Promedio Renta (10 años)
                                </label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-2.5 text-emerald-500 font-mono">$</span>
                                    <input type="text" id="inputAvgSalary" class="input-premium pl-7 font-mono font-bold text-emerald-100 border-emerald-500/30 focus:border-emerald-400 currency-input" placeholder="0">
                                </div>
                                <p class="text-[9px] text-emerald-400/60 mt-1">Requerido para SIS y Vejez Anticipada.</p>
                            </div>

                            <div>
                                <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Estado Civil</label>
                                <select id="inputCivilStatus" class="input-premium cursor-pointer">
                                    <option value="soltero">Soltero(a)</option>
                                    <option value="casado">Casado(a)</option>
                                    <option value="viudo">Viudo(a)</option>
                                </select>
                            </div>
                            <div class="pt-3 border-t border-paper/20">
                                <label class="flex items-center gap-2 p-3 rounded bg-oceanLight/50 border border-paper/10 cursor-pointer hover:border-acid/50 transition-colors">
                                    <input type="checkbox" id="flagBeneficiaries" class="w-4 h-4 rounded text-acid focus:ring-acid border-white/30 bg-oceanLight">
                                    <span class="text-sm font-sans font-semibold text-paper uppercase">¿Beneficiarios Legales?</span>
                                </label>
                            </div>
                            <div id="beneficiariesSection" class="hidden pl-4 border-l-2 border-acid/50 space-y-4 bg-oceanLight/20 p-4 rounded-r-lg mt-2">
                                <div>
                                    <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                        <input type="checkbox" id="checkSpouse" class="w-4 h-4 rounded text-acid focus:ring-acid border-white/30 bg-oceanLight">
                                        <span class="text-xs font-sans font-bold text-paper/80">Es Cónyuge / Pareja Civil</span>
                                    </label>
                                    <div id="spouseDobContainer" class="hidden ml-6">
                                        <label class="text-[10px] font-sans font-bold text-paper/50 uppercase">Fecha Nacimiento Cónyuge</label>
                                        <input type="date" id="inputSpouseDob" class="input-premium text-xs py-1">
                                    </div>
                                </div>
                                <div class="border-t border-paper/20 pt-3">
                                    <label class="text-xs font-sans font-bold text-paper/80 uppercase ml-1">Cantidad de Hijos</label>
                                    <input type="number" id="inputChildrenQty" class="input-premium text-sm w-20" value="0" min="0">
                                    <div id="childrenSlotsContainer" class="mt-3 space-y-2"></div>
                                </div>
                            </div>
                            <div id="bonoHijoContainer" class="hidden">
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1 flex items-center gap-1">
                                    <i class="ph ph-baby"></i> Hijos Nacidos Vivos
                                </label>
                                <input type="number" id="inputChildrenBorn" class="input-premium border-acid/30 focus:border-acid focus:ring-acid" value="0">
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1 flex items-center gap-1">
                                    <i class="ph ph-house-line"></i> Tramo RSH (PGU)
                                </label>
                                <select id="inputRSH" class="input-premium cursor-pointer border-acid/30 bg-oceanLight/50 focus:border-acid focus:ring-acid">
                                    <option value="-1">Sin información</option>
                                    <option value="90">0% - 90% (Califica)</option>
                                    <option value="100">91% - 100% (No califica)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel shadow-2xl border-paper/10 shadow-oceanLight/50">
                    <div class="p-6 border-b border-paper/20 bg-oceanLight/30 flex items-center gap-3">
                        <span class="bg-acid text-ocean w-7 h-7 rounded-full flex items-center justify-center font-bold text-sm font-mono">2</span>
                        <h2 class="text-xl font-serif italic text-paper uppercase tracking-wide">Patrimonio</h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-oceanLight/50 p-4 rounded-xl border border-paper/10 space-y-4">
                            <div>
                                <label class="text-xs font-sans font-bold text-acid uppercase ml-1 flex items-center gap-1"><i class="ph ph-wallet text-acid"></i> Saldo CCI (AFP)</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-2.5 text-white/50 font-mono">$</span>
                                    <input type="text" id="inputBalance" class="input-premium pl-7 font-mono font-bold text-acid text-glow currency-input" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Bono Reconocimiento</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-2.5 text-white/50 font-mono">$</span>
                                    <input type="text" id="inputBonoRec" class="input-premium pl-7 font-mono text-paper/80 currency-input" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-sans font-bold text-paper/60 uppercase ml-1">Saldo APV</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-2.5 text-white/50 font-mono">$</span>
                                    <input type="text" id="inputApv" class="input-premium pl-7 font-mono text-paper/80 currency-input" placeholder="0">
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-900/10 p-4 rounded-xl border border-purple-500/20 space-y-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="checkELD" class="w-4 h-4 rounded text-purple-400 focus:ring-purple-500 border-white/30 bg-oceanLight">
                                <span class="text-sm font-sans font-bold text-purple-300 uppercase">Retirar Excedente (ELD)</span>
                            </label>
                            <div id="eldInputContainer" class="hidden mt-2 relative">
                                <label class="text-[10px] font-sans text-purple-300 font-bold block mb-1">Monto a Retirar</label>
                                <span class="absolute left-3 top-6 text-purple-500 font-mono text-sm">$</span>
                                <input type="text" id="inputELDAmount" class="input-premium pl-7 font-mono text-purple-200 border-purple-900/50 focus:border-purple-500 currency-input" placeholder="0">
                            </div>
                        </div>
                        <div class="bg-sky-900/10 p-4 rounded-xl border border-sky-500/20">
                             <label class="text-xs font-sans font-bold text-sky-400 uppercase ml-1 flex items-center gap-1">
                                <i class="ph ph-clock-countdown"></i> Años Cotizados
                             </label>
                             <input type="number" id="inputYearsQuoted" class="input-premium mt-1 border-sky-900/50 focus:border-sky-500" placeholder="Ej: 25">
                        </div>
                    </div>
                </div>

                <div class="glass-panel shadow-2xl shadow-acid/20 border-acid/30 relative">
                    <div class="absolute top-0 left-0 w-1 h-full bg-acid"></div>
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-5">
                            <i class="ph ph-sliders text-acid text-2xl"></i>
                            <h2 class="text-xl font-serif italic text-paper uppercase tracking-wide">Configuración</h2>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex flex-col gap-1 p-3 rounded bg-oceanLight/50 border border-paper/10 hover:border-acid/50 transition-colors cursor-pointer">
                                    <input type="checkbox" class="sim-check rounded text-acid focus:ring-acid border-white/30 bg-oceanLight/80 w-4 h-4" value="rp" checked>
                                    <span class="text-xs font-sans font-bold text-paper mt-1">RETIRO PROGRAMADO</span>
                                </label>
                                <label class="flex flex-col gap-1 p-3 rounded bg-oceanLight/50 border border-acid/30 hover:border-acid transition-colors cursor-pointer">
                                    <input type="checkbox" class="sim-check rounded text-acid focus:ring-acid border-acid/50 bg-oceanLight/80 w-4 h-4" value="rv_simple" checked>
                                    <span class="text-xs font-sans font-bold text-acid mt-1">RENTA VITALICIA</span>
                                </label>
                            </div>
                            <div>
                                <span class="text-[10px] font-sans font-bold text-paper/60 uppercase tracking-wide">Periodos Garantizados RV</span>
                                <div class="grid grid-cols-2 gap-2 mt-2 bg-oceanLight/30 p-3 rounded">
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_gar_120" checked><span class="text-xs text-paper/80 font-mono">120m</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_gar_180" checked><span class="text-xs text-paper/80 font-mono">180m</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_gar_240" checked><span class="text-xs text-paper/80 font-mono">240m</span></label>
                                    <label class="flex items-center gap-2 p-1 border border-dashed border-paper/20 rounded bg-oceanLight/20">
                                        <input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" id="checkCustomGar">
                                        <span class="text-xs font-sans text-paper/80">Otro:</span>
                                        <input type="number" id="inputCustomGarMonths" class="w-12 text-xs bg-oceanLight text-paper/80 rounded px-1 focus:outline-none" placeholder="Mes" disabled>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-acid/10 p-4 rounded-lg border border-acid/30">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-sm font-sans font-bold text-acid uppercase tracking-wide flex items-center gap-2">
                                        <i class="ph ph-lightning-fill"></i> Renta Aumentada
                                    </span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="inputIncreasePct" value="100" class="w-14 text-right text-sm font-mono bg-oceanLight/50 border border-acid/30 rounded px-2 text-acid focus:ring-acid" min="1" max="100">
                                        <span class="text-sm text-acid">%</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_12" checked><span class="text-[10px] text-paper/80">12m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_24" checked><span class="text-[10px] text-paper/80">24m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_36"><span class="text-[10px] text-paper/80">36m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_48"><span class="text-[10px] text-paper/80">48m</span></label>
                                    <label class="flex items-center gap-1"><input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" value="rv_inc_60"><span class="text-[10px] text-paper/80">60m</span></label>
                                    <label class="flex items-center gap-1 col-span-1 p-1 border border-dashed border-paper/20 rounded bg-oceanLight/20 w-full">
                                        <input type="checkbox" class="sim-check rounded text-acid bg-oceanLight/80 border-white/30" id="checkCustomInc">
                                        <span class="text-[9px] text-paper/80 mr-1">Otro:</span>
                                        <input type="number" id="inputCustomIncMonths" class="w-full text-xs border border-white/20 bg-oceanLight text-paper/80 rounded px-1 focus:outline-none focus:border-acid" placeholder="Mes" disabled>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button id="btnSimulate" onclick="runSimulation()" class="cta-button mt-6 w-full py-4 text-lg group flex justify-center items-center gap-2">
                            <span>Simular Pensiones</span>
                            <i class="ph ph-arrow-right font-bold group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-10">
                <div id="placeholderState" class="h-full min-h-[500px] flex flex-col items-center justify-center glass-panel rounded-3xl shadow-2xl border border-paper/10 p-12 text-center">
                    <div class="w-20 h-20 bg-oceanLight/50 rounded-full flex items-center justify-center mb-6 animate-pulse ring-4 ring-acid/20 text-acid"><i class="ph ph-calculator text-4xl"></i></div>
                    <h3 class="text-3xl font-serif italic font-bold text-paper mb-2">Resultados de Simulación</h3>
                    <p class="text-white/70 text-base max-w-sm mx-auto font-sans">Ingresa tus datos y presiona **Simular** para desplegar el análisis.</p>
                </div>

                <div id="resultsDashboard" class="hidden space-y-10 animate-fade-in-up">
                    <div class="flex justify-between items-center">
                        <h1 class="text-3xl font-serif italic text-paper">Resultados Consolidado</h1>
                        <button id="btnDownloadPDF" class="cta-button bg-oceanLight text-acid py-2 px-3 text-sm flex items-center gap-2" style="box-shadow: 0 4px 0px 0px #022C43; font-weight: bold;">
                            <i class="ph ph-file-pdf text-acid text-lg"></i> Descargar Informe PDF
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-panel p-5 shadow-lg border-t-4 border-acid/50 relative overflow-hidden">
                            <span class="text-[10px] font-sans font-bold text-paper/60 uppercase tracking-widest">Capital Consolidado</span>
                            <div class="text-xl font-mono font-bold text-acid mt-2 truncate text-glow" id="resTotalCapital">$0</div>
                            <div class="text-[10px] text-white/50 mt-1 font-sans">Incluye SIS si aplica</div>
                        </div>
                        
                        <div id="cardELD" class="glass-panel bg-purple-900/20 p-5 shadow-lg border-t-4 border-purple-500 relative overflow-hidden hidden">
                            <span class="text-[10px] font-sans font-bold text-purple-400 uppercase tracking-widest">Monto Retirado ELD</span>
                            <div class="text-xl font-mono font-bold text-purple-300 mt-2 truncate" id="resEldAmount">$0</div>
                            <div class="text-[10px] text-purple-400/70 mt-1 font-sans">Pago Único Inicial</div>
                        </div>

                        <div id="cardSIS" class="glass-panel bg-emerald-900/20 p-5 shadow-lg border-t-4 border-emerald-500 relative overflow-hidden hidden">
                            <span class="text-[10px] font-sans font-bold text-emerald-400 uppercase tracking-widest">Aporte Adicional SIS</span>
                            <div class="text-xl font-mono font-bold text-emerald-300 mt-2 truncate" id="resSISAmount">$0</div>
                            <div class="text-[10px] text-emerald-400/70 mt-1 font-sans">Seguro Inv/Sob</div>
                        </div>

                        <div class="glass-panel p-5 shadow-lg border-t-4 relative overflow-hidden" id="cardPGU">
                            <span class="text-[10px] font-sans font-bold text-paper/60 uppercase tracking-widest">Estado PGU</span>
                            <div class="text-xl font-serif italic font-bold text-paper mt-2 truncate" id="resPguStatus">Pendiente</div>
                            <div id="resPguReasonContainer" class="hidden mt-1 p-1 bg-white/5 rounded border border-white/10">
                                <p class="text-[9px] text-white/70 font-sans font-medium"><span id="resPguReason">...</span></p>
                            </div>
                        </div>

                        <div class="glass-panel p-5 shadow-lg border-t-4 border-pink-500 relative overflow-hidden group hover:border-pink-400 transition-transform duration-300">
                            <span class="text-[10px] font-sans font-bold text-paper/60 uppercase tracking-widest">Bono por Hijo</span>
                            <div class="text-xl font-mono font-bold text-pink-400 mt-2 truncate" id="resBonoHijo">$0</div>
                            <div class="text-[10px] text-white/50 mt-1 font-sans">Estimado</div>
                        </div>

                        <div class="glass-panel p-5 shadow-lg border-t-4 border-sky-500 relative overflow-hidden">
                            <span class="text-[10px] font-sans font-bold text-paper/60 uppercase tracking-widest">Beneficio Cotización</span>
                            <div class="text-xl font-mono font-bold text-sky-400 mt-2 truncate" id="resBeneficioCotizacion">$0</div>
                            <div class="text-[10px] text-white/50 mt-1 font-sans" id="resBeneficioCotizacionDesc">0,1 UF/año</div>
                        </div>
                    </div>
                    
                    <div id="tablesContainer" class="space-y-8"></div>

                    <div class="glass-panel p-8 shadow-2xl shadow-oceanLight/50">
                         <div class="flex justify-between items-end mb-8">
                            <div>
                                <h3 class="text-xl font-serif italic text-paper uppercase tracking-wide">Proyección</h3>
                                <p class="text-sm text-white/60 mt-1 font-sans">Flujo mensual estimado.</p>
                            </div>
                        </div>
                        <div class="chart-container" style="position: relative; height:400px; width:100%">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="fixed top-5 right-5 z-50 hidden transition-all duration-300 transform translate-y-[-20px] opacity-0">
        <div id="toast-content" class="flex items-center w-full max-w-xs p-4 text-gray-500 glass-panel rounded-lg shadow-xl dark:text-white/80" role="alert">
            <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
            <div class="ml-3 text-sm font-sans font-medium" id="toast-message">Mensaje</div>
        </div>
    </div>

    <footer class="bg-oceanDark pt-16 pb-8 border-t border-white/10 text-sm mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center text-xs text-gray-600 font-mono">
                <p>&copy; 2025 La Justa Fintech SpA. Todos los derechos reservados.</p>
                
                <a href="index.html" class="mt-4 md:mt-0 text-xs border border-white/20 text-gray-400 hover:text-white hover:border-white px-4 py-2 rounded transition-colors flex items-center gap-2 btn-3d bg-oceanLight/30">
                    <i class="ph ph-house"></i> Volver al Inicio
                </a>
            </div>
        </div>
    </footer>

    <script>
        lucide.createIcons();
    </script>

    <script>
        // --- 1. CONSTANTES ACTUARIALES (V3) ---
        const PGU_FACTOR_MAX_UF = 5.64; 
        const PGU_CUTOFF_FULL_UF = 19.5;    
        const PGU_CUTOFF_PARTIAL_UF = 32.0; 
        const MIN_WAGE = 500000; 
        const INTERES_TECNICO_RP = 0.042; // 4.2% Anual para cálculo de anualidad
        const AFP_COMMISSION_RP = 0.0125; // 1.25% Comisión Retiro Programado
        
        let currentUTM = 66628; 
        let currentUF = 0;
        
        // Tabla de Impuesto Mensual (2da Categoría)
        const TAX_BRACKETS = [
            { limit: 13.5, factor: 0,     deduction: 0 },
            { limit: 30,   factor: 0.04,  deduction: 0.54 },
            { limit: 50,   factor: 0.08,  deduction: 1.74 },
            { limit: 70,   factor: 0.135, deduction: 4.49 },
            { limit: 90,   factor: 0.23,  deduction: 11.14 },
            { limit: 120,  factor: 0.304, deduction: 17.8 },
            { limit: 310,  factor: 0.35,  deduction: 23.32 },
            { limit: 9999, factor: 0.40,  deduction: 38.82 }
        ];

        let lineChartInstance = null;
        let lastSimulationData = null; 

        // --- Formatters ---
        const formatCLP = (num) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(num);
        const formatNumber = (num) => new Intl.NumberFormat('es-CL', { maximumFractionDigits: 0 }).format(num);
        const formatUF = (num) => new Intl.NumberFormat('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);

        const getCurrencyValue = (id) => {
            const val = document.getElementById(id).value;
            return val ? parseFloat(val.replace(/\./g, '')) : 0;
        };
        const getUFValue = () => {
            const val = document.getElementById('inputUFValue').value;
            return val ? parseFloat(val.replace(/\./g, '').replace(',', '.')) : 0;
        };

        // --- Notifications ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');
            let iconClass = type === 'error' ? 'text-red-500 bg-red-100' : 'text-acid bg-oceanLight/50';
            msgEl.textContent = message;
            iconEl.className = `inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg ${iconClass}`;
            iconEl.innerHTML = type === 'error' ? '<i class="ph ph-warning-circle text-xl"></i>' : '<i class="ph ph-check-circle text-xl"></i>';
            toast.classList.remove('hidden', 'translate-y-[-20px]', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-[-20px]', 'opacity-0'); setTimeout(() => toast.classList.add('hidden'), 300); }, 4000);
        }

        // --- Auto Update UF & UTM (MODIFICADO PARA TRAER AMBOS) ---
        async function fetchIndicators() {
            const inputUF = document.getElementById('inputUFValue');
            const inputUTM = document.getElementById('inputUTMNavbar');
            
            if(inputUF) inputUF.placeholder = "Cargando...";
            
            try {
                const response = await fetch('https://mindicador.cl/api');
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                
                // Actualizar UF
                if(inputUF && data.uf) {
                     inputUF.value = new Intl.NumberFormat('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(data.uf.valor);
                     showToast("Indicadores Actualizados", 'success');
                }
                
                // Actualizar UTM
                if(inputUTM && data.utm) {
                    inputUTM.value = new Intl.NumberFormat('es-CL', { maximumFractionDigits: 0 }).format(data.utm.valor);
                }
                
            } catch (error) {
                showToast("Error al obtener indicadores", 'error');
                if(inputUF) inputUF.placeholder = "0,00";
            }
        }
        
        // Alias para compatibilidad con botones antiguos
        function fetchUF() { fetchIndicators(); }

        // --- Validation ---
        function fnValidaRut(rut) {
            if (!rut || rut.trim().length < 3) return false;
            rut = rut.replace(/^0+|[^0-9kK]+/g, '').toUpperCase();
            if (rut.length < 2) return false;
            const t = parseInt(rut.slice(0, -1), 10);
            let m = 0, s = 1, cuerpo = t;
            for (; cuerpo; cuerpo = Math.floor(cuerpo / 10)) s = (s + cuerpo % 10 * (9 - m++ % 6)) % 11;
            return (s ? s - 1 : 'K') == rut.slice(-1);
        }

        // Listeners for Inputs
        window.addEventListener('DOMContentLoaded', fetchIndicators);
        
        // RUT Input Listener & Validation
        const inputRut = document.getElementById('inputRut');
        const rutErrorMsg = document.getElementById('rutErrorMsg');
        const rutIcon = document.getElementById('rutStatusIcon');

        inputRut.addEventListener('input', function(e) {
            let rut = e.target.value.replace(/[^0-9kK]/g, "");
            if(rut.length > 1) {
                rut = rut.replace(/^0+/, "");
            }
            if (rut.length > 1) {
                const cuerpo = rut.slice(0, -1);
                const dv = rut.slice(-1).toUpperCase();
                const cuerpoFormateado = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                e.target.value = `${cuerpoFormateado}-${dv}`;
            } else {
                e.target.value = rut.toUpperCase();
            }
            inputRut.classList.remove('input-error', 'border-red-500', 'border-green-500');
            rutErrorMsg.classList.add('hidden');
            rutIcon.classList.add('hidden');
        });

        inputRut.addEventListener('blur', function() {
            const valClean = this.value;
            if(valClean.length > 0) {
                if(fnValidaRut(valClean)) {
                    this.classList.remove('input-error', 'border-red-500');
                    this.classList.add('border-green-500');
                    rutIcon.innerHTML = '<i class="ph ph-check-circle text-green-500 text-lg"></i>';
                    rutIcon.classList.remove('hidden');
                    rutErrorMsg.classList.add('hidden');
                } else {
                    this.classList.add('input-error', 'border-red-500');
                    rutIcon.innerHTML = '<i class="ph ph-warning-circle text-red-500 text-lg"></i>';
                    rutIcon.classList.remove('hidden');
                    rutErrorMsg.classList.remove('hidden');
                    showToast("El RUT ingresado no es válido.", 'error');
                }
            }
        });

        // Formats
        ['inputBalance','inputBonoRec','inputApv','inputELDAmount','inputAvgSalary'].forEach(id => {
            document.getElementById(id).addEventListener('input', function(e) {
                let val = e.target.value.replace(/\D/g, '');
                e.target.value = val ? new Intl.NumberFormat('es-CL').format(parseInt(val)) : '';
            });
        });

        // UI Toggles
        document.getElementById('checkELD').addEventListener('change', e => document.getElementById('eldInputContainer').classList.toggle('hidden', !e.target.checked));
        document.getElementById('flagBeneficiaries').addEventListener('change', e => document.getElementById('beneficiariesSection').classList.toggle('hidden', !e.target.checked));
        document.getElementById('checkSpouse').addEventListener('change', e => document.getElementById('spouseDobContainer').classList.toggle('hidden', !e.target.checked));
        document.getElementById('inputGender').addEventListener('change', e => document.getElementById('bonoHijoContainer').classList.toggle('hidden', e.target.value !== 'F'));
        
        document.getElementById('checkCustomGar').addEventListener('change', e => {
            const input = document.getElementById('inputCustomGarMonths');
            input.disabled = !e.target.checked;
            if(e.target.checked) input.focus(); else input.value = '';
        });
        document.getElementById('checkCustomInc').addEventListener('change', e => {
            const input = document.getElementById('inputCustomIncMonths');
            input.disabled = !e.target.checked;
            if(e.target.checked) input.focus(); else input.value = '';
        });

        // --- MATH ENGINE V3 ---
        function calculateAge(dob) {
            if(!dob) return 0;
            return Math.abs(new Date(Date.now() - new Date(dob).getTime()).getUTCFullYear() - 1970);
        }

        function calculateCNU_V3(age, gender, hasSpouse) {
            const r = INTERES_TECNICO_RP; 
            let lifeExp = (gender === 'M') ? 86 : 91;
            let yearsToLive = Math.max(lifeExp - age, 5); 
            let annuityFactor = (1 - Math.pow(1 + r, -yearsToLive)) / r;
            let cnu = annuityFactor * 12; 
            if (hasSpouse) cnu *= 1.15; 
            return cnu;
        }

        function calculateTax(amount) {
            if (!currentUTM) currentUTM = 66000;
            const utmVal = amount / currentUTM;
            const b = TAX_BRACKETS.find(x => utmVal <= x.limit);
            return b ? Math.round(Math.max(0, (amount * b.factor) - (b.deduction * currentUTM))) : 0;
        }

        // --- MAIN SIMULATION ---
        function runSimulation() {
            const rut = document.getElementById('inputRut').value;
            if(!fnValidaRut(rut)) { showToast("RUT Inválido", 'error'); return; }
            const uf = getUFValue();
            if(!uf) { showToast("Falta valor UF", 'error'); return; }
            const dob = document.getElementById('inputDob').value;
            if(!dob) { showToast("Falta Fecha Nacimiento", 'error'); return; }

            const gender = document.getElementById('inputGender').value;
            const age = calculateAge(dob);
            const pensionType = document.getElementById('inputPensionType').value;
            const avgSalary = getCurrencyValue('inputAvgSalary');
            
            let capital = getCurrencyValue('inputBalance') + getCurrencyValue('inputBonoRec') + getCurrencyValue('inputApv');
            if(gender === 'F') {
                const kids = parseInt(document.getElementById('inputChildrenBorn').value)||0;
                capital += (kids * (18 * MIN_WAGE * 0.10) * 1.6); 
            }
            const eld = getCurrencyValue('inputELDAmount');
            if(eld >= capital) { showToast("ELD excede capital", 'error'); return; }
            capital -= eld;

            let sisContribution = 0;
            if (pensionType === 'invalidez_total' || pensionType === 'sobrevivencia') {
                if (avgSalary > 0) {
                    const targetPension = avgSalary * 0.7; 
                    const cnu = calculateCNU_V3(age, gender, document.getElementById('checkSpouse').checked);
                    const requiredCapital = (targetPension / uf) * cnu * uf; 
                    if (requiredCapital > capital) {
                        sisContribution = requiredCapital - capital;
                        capital = requiredCapital; 
                    }
                }
            }

            const hasSpouse = document.getElementById('checkSpouse').checked;
            const cnu = calculateCNU_V3(age, gender, hasSpouse);
            const basePensionUF = (capital / uf) / cnu;
            const factorRV = 0.92; 

            const buildRow = (label, amountUF, isInc=false, permUF=0, isRP=false) => {
                const clp = Math.round(amountUF * uf);
                let commission = 0;
                if(isRP) {
                    commission = Math.round(clp * AFP_COMMISSION_RP);
                }
                const health = Math.round(clp * 0.07);
                const taxableBase = clp - health;
                const tax = calculateTax(taxableBase);
                const liq = clp - health - tax - commission;
                const permLiq = isInc ? Math.round((permUF*uf)*0.93 - calculateTax((permUF*uf)*0.93)) : 0;
                return { label, uf: amountUF, clp, health, taxValue: tax, liquid: liq, isIncreased: isInc, permanentLiquid: permLiq, permUF };
            };

            const groupImmediate = [];
            const selected = Array.from(document.querySelectorAll('.sim-check:checked')).map(c => c.value);
            
            const ufSimple = basePensionUF * factorRV;
            
            if(selected.includes('rv_simple')) groupImmediate.push(buildRow('Simple Inmediata', ufSimple));
            if(selected.includes('rv_gar_120')) groupImmediate.push(buildRow('Garantizada 10 Años', ufSimple * 0.97));
            if(selected.includes('rv_gar_180')) groupImmediate.push(buildRow('Garantizada 15 Años', ufSimple * 0.95));
            if(selected.includes('rv_gar_240')) groupImmediate.push(buildRow('Garantizada 20 Años', ufSimple * 0.93));
            
            if(document.getElementById('checkCustomGar').checked) {
                const m = parseInt(document.getElementById('inputCustomGarMonths').value)||0;
                if(m>0) groupImmediate.push(buildRow(`Garantizada ${m} Meses`, ufSimple * (1-(m*0.0003))));
            }

            const increasedGroups = [];
            const incPct = parseFloat(document.getElementById('inputIncreasePct').value) || 100;
            let incMonths = [12, 24, 36, 48, 60].filter(m => selected.includes(`rv_inc_${m}`));
            
            if(document.getElementById('checkCustomInc').checked) {
                const cm = parseInt(document.getElementById('inputCustomIncMonths').value)||0;
                if(cm>0 && !incMonths.includes(cm)) incMonths.push(cm);
            }
            incMonths.sort((a,b) => a - b);

            incMonths.forEach(m => {
                const factorTemp = 1 + (incPct/100);
                const capitalTotal = capital / uf;
                const retiroTemporal = (ufSimple * factorTemp) * m;
                const capitalRestante = capitalTotal - retiroTemporal;
                
                if(capitalRestante > 0) {
                    const ratio = capitalRestante / (capitalTotal - (ufSimple*m)); 
                    const permUF = ufSimple * ratio * 0.98; 
                    const tempUF = permUF * factorTemp;

                    const rows = [];
                    rows.push(buildRow(`Simple (+${incPct}%)`, tempUF, true, permUF));
                    if(selected.includes('rv_gar_120')) rows.push(buildRow('Garantizada 10 Años', tempUF*0.97, true, permUF*0.97));
                    if(selected.includes('rv_gar_240')) rows.push(buildRow('Garantizada 20 Años', tempUF*0.93, true, permUF*0.93));
                    
                    increasedGroups.push({ title: `Renta Aumentada (${m} Meses)`, rows });
                }
            });

            const groupRP = [];
            if(selected.includes('rp')) {
                groupRP.push(buildRow('Retiro Programado (Año 1)', basePensionUF, false, 0, true));
            }

            let pgu = 0;
            if(age >= 65 && document.getElementById('inputRSH').value !== '100') {
                const max = Math.round(PGU_FACTOR_MAX_UF * uf);
                const baseLiq = Math.round(basePensionUF * uf);
                const cutUpper = Math.round(PGU_CUTOFF_PARTIAL_UF * uf);
                const cutLower = Math.round(PGU_CUTOFF_FULL_UF * uf);
                if (baseLiq < cutLower) pgu = max;
                else if (baseLiq < cutUpper) pgu = Math.round(max * ((cutUpper - baseLiq)/(cutUpper - cutLower)));
            }
            
            lastSimulationData = {
                clientName: document.getElementById('inputName').value,
                rut, capital, eld, benefitsTotal: pgu,
                immediate: groupImmediate, rp: groupRP, increased: increasedGroups,
                ufValue: uf
            };

            renderDashboard(capital, eld, sisContribution, pgu, groupImmediate, increasedGroups, groupRP);
        }

        function renderDashboard(capital, eld, sis, pgu, imm, inc, rp) {
            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultsDashboard').classList.remove('hidden');
            
            document.getElementById('resTotalCapital').innerText = formatCLP(capital);
            document.getElementById('cardELD').classList.toggle('hidden', eld <= 0);
            if(eld>0) document.getElementById('resEldAmount').innerText = formatCLP(eld);
            
            document.getElementById('cardSIS').classList.toggle('hidden', sis <= 0);
            if(sis>0) document.getElementById('resSISAmount').innerText = formatCLP(sis);

            document.getElementById('resPguStatus').innerText = pgu > 0 ? formatCLP(pgu) : "No Aplica/Pendiente";

            const cont = document.getElementById('tablesContainer');
            cont.innerHTML = '';

            const makeTable = (t, r, isInc) => {
                if(!r.length) return '';
                let html = `<div class="glass-panel overflow-hidden mb-6"><div class="bg-oceanLight/50 px-6 py-3 font-bold text-acid border-b border-white/10">${t}</div><table class="w-full text-sm text-right">`;
                html += `<thead class="bg-white/5 text-paper/70"><tr><th class="p-3 text-left">Modalidad</th><th class="p-3">UF</th><th class="p-3">Liq. Inicial</th>${isInc?'<th class="p-3 text-emerald-400">Liq. Futuro</th>':''}</tr></thead><tbody>`;
                r.forEach(x => {
                    html += `<tr class="border-b border-white/5 hover:bg-white/5"><td class="p-3 text-left font-medium text-white">${x.label}</td><td class="p-3 font-mono text-paper/60">${formatUF(x.uf)}</td><td class="p-3 font-mono text-acid font-bold text-lg">${formatCLP(x.liquid)}</td>${isInc?`<td class="p-3 font-mono text-emerald-400">${formatCLP(x.permanentLiquid)}</td>`:''}</tr>`;
                });
                return html + '</tbody></table></div>';
            };

            cont.innerHTML += makeTable('Renta Vitalicia Inmediata', imm, false);
            inc.forEach(g => cont.innerHTML += makeTable(g.title, g.rows, true));
            cont.innerHTML += makeTable('Retiro Programado', rp, false);

            updateChart(imm, inc, rp, pgu);
        }

        function updateChart(imm, inc, rp, ben) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if(lineChartInstance) lineChartInstance.destroy();
            
            const labels = Array.from({length:21}, (_,i)=>`Año ${i}`);
            const datasets = [];
            
            if(rp.length) datasets.push({label:'Retiro Programado', data: labels.map((_,i)=>rp[0].liquid*Math.pow(0.98,i) + ben), borderColor:'#94a3b8', borderDash:[5,5]});
            if(imm.length) datasets.push({label:'RV Simple', data: Array(21).fill(imm[0].liquid + ben), borderColor:'#CCFF00', borderWidth:3});
            
            if(inc.length) {
                const g = inc[0]; 
                const dur = parseInt(g.title.match(/\d+/)[0]);
                const row = g.rows[0];
                const data = labels.map((_,i) => (i*12 < dur ? row.liquid : row.permanentLiquid) + ben);
                datasets.push({label: `Aumentada ${dur}m`, data: data, borderColor: '#10b981'});
            }

            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = '#1e293b';
            lineChartInstance = new Chart(ctx, {
                type:'line', data:{labels, datasets},
                options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'top'}}}
            });
        }

        function generatePDF() {
            if(!lastSimulationData) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const Ocean='#022C43', Acid='#CCFF00', Gray='#334155';

            doc.setFont('helvetica', 'normal');
            doc.setFillColor(Ocean); doc.rect(0,0,pageWidth,20,'F');
            doc.setTextColor(255,255,255); doc.setFont('times','italic'); doc.setFontSize(16); doc.text('La Justa', 15,14);
            doc.setTextColor(Acid); doc.setFont('courier','bold'); doc.setFontSize(8); doc.text('INFORME PREVISIONAL DETALLADO', pageWidth-15,14,{align:'right'});

            let y = 35;
            doc.setTextColor(Ocean); doc.setFont('times','italic'); doc.setFontSize(18); doc.text('Ficha de Cliente', 15, y);
            y+=10; doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(Gray);
            
            doc.text(`Cliente: ${lastSimulationData.clientName}`, 15, y);
            doc.text(`RUT: ${lastSimulationData.rut}`, 120, y); y+=7;
            doc.text(`Capital Total: ${formatCLP(lastSimulationData.capital)}`, 15, y);
            doc.text(`Valor UF: $${formatUF(lastSimulationData.ufValue)}`, 120, y); y+=15;

            const printTable = (title, rows, isInc) => {
                if(!rows || rows.length===0) return;
                if(y > 250) { doc.addPage(); y=20; }
                
                doc.setTextColor(Ocean); doc.setFontSize(12); doc.setFont('helvetica','bold');
                doc.text(title, 15, y); y+=2;

                const headers = isInc 
                    ? [['Modalidad','UF','Bruto','Salud','Impuesto','Liq. Temporal','Liq. Futura']]
                    : [['Modalidad','UF','Bruto','Salud','Impuesto','Líquido']];
                
                const body = rows.map(r => {
                    const base = [r.label, formatUF(r.uf), formatCLP(r.clp), formatCLP(r.health), formatCLP(r.taxValue), formatCLP(r.liquid)];
                    if(isInc) base.push(formatCLP(r.permanentLiquid));
                    return base;
                });

                doc.autoTable({
                    startY: y+3, head: headers, body: body,
                    headStyles: {fillColor: Ocean, textColor: 255},
                    styles: {fontSize: 8, cellPadding: 2},
                    columnStyles: {0: {cellWidth: isInc?40:60}}
                });
                y = doc.lastAutoTable.finalY + 15;
            };

            printTable('Renta Vitalicia Inmediata', lastSimulationData.immediate, false);
            printTable('Retiro Programado', lastSimulationData.rp, false);
            
            if(lastSimulationData.increased) {
                lastSimulationData.increased.forEach(g => printTable(g.title, g.rows, true));
            }

            doc.setFontSize(7); doc.setTextColor(150);
            doc.text("Valores referenciales V3. Requiere validación SCOMP. Generado por La Justa.", 15, 285);
            doc.save(`LaJusta_Informe_${lastSimulationData.rut}.pdf`);
        }

        document.getElementById('btnDownloadPDF').addEventListener('click', generatePDF);
    </script>
</body>
</html>
