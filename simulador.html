<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Justa - Motor Actuarial V4.1</title>
    
    <!-- Scripts & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ocean: '#022C43', oceanLight: '#053b58', oceanDark: '#011826',
                        acid: '#CCFF00', acidHover: '#b3e600', paper: '#F3F4F6',
                    },
                    fontFamily: {
                        serif: ['"Instrument Serif"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"Space Mono"', 'monospace'], 
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #022C43; color: white; font-family: 'Inter', sans-serif; }
        .grid-bg { background-image: linear-gradient(rgba(204, 255, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(204, 255, 0, 0.05) 1px, transparent 1px); background-size: 40px 40px; position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .cta-button { background-color: #CCFF00; color: #022C43; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; border-radius: 0.25rem; transition: all 0.2s ease; box-shadow: 0 4px 0px 0px #8eb300; }
        .cta-button:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 0px 0px 0px #8eb300; }
        .glass-panel { background: rgba(5, 59, 88, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; }
        .input-premium { background-color: rgba(5, 59, 88, 0.2) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: #F3F4F6 !important; transition: all 0.2s; width: 100%; padding: 0.6rem; border-radius: 0.375rem; font-size: 0.875rem; }
        .input-premium:focus { border-color: #CCFF00 !important; box-shadow: 0 0 0 1px #CCFF00 !important; outline: none; }
        .input-error { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .text-glow { text-shadow: 0 0 15px rgba(204, 255, 0, 0.5); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #011826; }
        ::-webkit-scrollbar-thumb { background: #053b58; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #CCFF00; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeInUp 0.6s ease-out forwards; }
    </style>
</head>
<body class="antialiased selection:bg-acid selection:text-ocean flex flex-col min-h-screen">
    <div class="grid-bg"></div>

    <!-- Navigation -->
    <nav class="fixed w-full z-50 glass-panel border-b-0 border-white/5 rounded-none top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3 group">
                        <div class="h-10 w-10 bg-acid rounded-lg flex items-center justify-center">
                            <i class="ph ph-scales text-ocean text-2xl font-bold"></i>
                        </div>
                        <span class="font-serif text-2xl md:text-3xl text-acid tracking-wide">La Justa<span class="text-white">.</span></span>
                    </div>
                    <div class="hidden lg:flex items-center gap-4 bg-oceanLight/30 border border-white/10 px-4 py-2 rounded-lg backdrop-blur-md">
                        <div class="flex flex-col items-start leading-none border-r border-white/10 pr-4">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-1 flex items-center gap-2">UF HOY <i id="refreshUF" class="ph ph-arrows-clockwise cursor-pointer hover:rotate-180 transition-transform duration-500"></i></span>
                            <div class="flex items-center"><span class="text-white/40 font-mono mr-1 text-xs">$</span><input type="text" id="navUF" readonly class="bg-transparent border-none text-white text-xs font-bold font-mono w-20 focus:outline-none"></div>
                        </div>
                        <div class="flex flex-col items-start leading-none">
                            <span class="text-[9px] font-bold text-acid uppercase tracking-widest mb-1">UTM MES</span>
                            <div class="flex items-center"><span class="text-white/40 font-mono mr-1 text-xs">$</span><input type="text" id="navUTM" readonly class="bg-transparent border-none text-white text-xs font-bold font-mono w-20 focus:outline-none"></div>
                        </div>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-8 font-mono text-xs tracking-widest">
                    <a href="#" class="text-acid border-b border-acid pb-1">SIMULADOR</a>
                    <a href="#" class="text-white/60 hover:text-acid transition-colors">AUDITOR</a>
                    <a href="#" class="bg-white/5 border border-white/10 px-4 py-2 rounded hover:bg-acid hover:text-ocean transition-all">ACCESO</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-32 pb-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full flex-grow">
        <header class="text-center mb-12 animate-fade-in">
            <span class="font-mono text-acid text-xs tracking-[0.4em] uppercase mb-3 block">Módulo Actuarial V4.1</span>
            <h1 class="font-serif text-4xl md:text-6xl text-white mb-4">Simulador de Pensión</h1>
            <p class="text-gray-400 max-w-2xl mx-auto text-sm md:text-base">Proyección técnica basada en parámetros vigentes 2025. Incluye análisis de Renta Aumentada y Beneficiarios.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Sidebar: Inputs -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Step 1 -->
                <div class="glass-panel overflow-hidden border-white/5">
                    <div class="p-5 border-b border-white/10 bg-oceanLight/20 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="bg-acid text-ocean w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs font-mono">1</span>
                            <h2 class="text-sm font-bold uppercase tracking-widest text-paper">Perfil Personal</h2>
                        </div>
                        <i class="ph ph-user text-acid text-xl"></i>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-acid uppercase tracking-tighter mb-1 block">Nombres *</label>
                                <input type="text" id="inFirstName" class="input-premium" placeholder="Ej: Emilia">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-acid uppercase tracking-tighter mb-1 block">Apellidos *</label>
                                <input type="text" id="inLastName" class="input-premium" placeholder="Ej: Clarke">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-acid uppercase tracking-tighter mb-1 block">RUT</label>
                                <div class="relative">
                                    <input type="text" id="inRut" class="input-premium font-mono" placeholder="12.345.678-9" maxlength="12">
                                    <span id="rutCheck" class="absolute right-3 top-2.5"></span>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-acid uppercase tracking-tighter mb-1 block">Email *</label>
                                <input type="email" id="inEmail" class="input-premium font-mono text-xs" placeholder="correo@ejemplo.cl">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-acid uppercase tracking-tighter mb-1 block">F. Nacimiento *</label>
                                <input type="date" id="inDob" class="input-premium">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-acid uppercase tracking-tighter mb-1 block">Género</label>
                                <select id="inGender" class="input-premium">
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                </select>
                            </div>
                        </div>
                        <div>
                             <label class="flex items-center gap-3 p-3 rounded bg-oceanLight/30 border border-white/5 cursor-pointer">
                                <input type="checkbox" id="inHasSpouse" class="w-4 h-4 rounded text-acid focus:ring-acid border-white/20 bg-oceanDark">
                                <span class="text-xs font-bold text-paper/80 uppercase">¿Tiene Cónyuge / Beneficiarios?</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="glass-panel overflow-hidden border-white/5">
                    <div class="p-5 border-b border-white/10 bg-oceanLight/20 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="bg-acid text-ocean w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs font-mono">2</span>
                            <h2 class="text-sm font-bold uppercase tracking-widest text-paper">Patrimonio</h2>
                        </div>
                        <i class="ph ph-money text-acid text-xl"></i>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-acid uppercase tracking-tighter mb-1 block">Saldo CCI (AFP) *</label>
                            <input type="text" id="inBalance" class="input-premium font-mono text-acid text-lg font-bold currency" placeholder="0">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-paper/60 uppercase tracking-tighter mb-1 block">Bono Rec.</label>
                                <input type="text" id="inBonoRec" class="input-premium font-mono currency" placeholder="0">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-paper/60 uppercase tracking-tighter mb-1 block">APV</label>
                                <input type="text" id="inApv" class="input-premium font-mono currency" placeholder="0">
                            </div>
                        </div>
                        <div class="bg-purple-900/10 p-3 rounded-lg border border-purple-500/20">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" id="inCheckEld" class="w-4 h-4 rounded text-purple-400 focus:ring-purple-500 border-white/20 bg-oceanDark">
                                <span class="text-xs font-bold text-purple-300 uppercase">Retirar Excedente (ELD)</span>
                            </label>
                            <input type="text" id="inEldAmount" class="hidden input-premium font-mono border-purple-500/30 currency" placeholder="Monto $">
                        </div>
                    </div>
                </div>

                <!-- Configuration Step -->
                <div class="glass-panel overflow-hidden border-acid/20">
                    <div class="p-5 border-b border-white/10 bg-acid/5 flex items-center gap-3">
                        <i class="ph ph-gear text-acid text-xl"></i>
                        <h2 class="text-sm font-bold uppercase tracking-widest text-acid">Configuración</h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                             <span class="text-[10px] font-bold text-paper/40 uppercase mb-2 block">Periodos Garantizados</span>
                             <div class="grid grid-cols-2 gap-2">
                                 <label class="flex items-center gap-2 text-[10px] text-paper/70"><input type="checkbox" class="cfg-gar w-3 h-3" value="120" checked> 120m</label>
                                 <label class="flex items-center gap-2 text-[10px] text-paper/70"><input type="checkbox" class="cfg-gar w-3 h-3" value="180" checked> 180m</label>
                                 <label class="flex items-center gap-2 text-[10px] text-paper/70"><input type="checkbox" class="cfg-gar w-3 h-3" value="240" checked> 240m</label>
                                 <div class="flex items-center gap-1">
                                     <input type="checkbox" id="inCfgGarCustom" class="w-3 h-3">
                                     <input type="number" id="inCfgGarVal" class="w-full bg-white/5 border border-white/10 text-[10px] p-1 rounded" placeholder="Otro" disabled>
                                 </div>
                             </div>
                        </div>
                        <div>
                             <span class="text-[10px] font-bold text-acid/60 uppercase mb-2 block">Renta Aumentada (%)</span>
                             <div class="flex items-center gap-2 mb-3">
                                 <input type="number" id="inIncPct" value="100" class="w-16 bg-oceanLight border border-acid/30 text-xs p-1 text-center rounded text-acid">
                                 <span class="text-xs text-acid">%</span>
                             </div>
                             <div class="grid grid-cols-3 gap-2">
                                 <label class="flex items-center gap-1 text-[9px] text-paper/60"><input type="checkbox" class="cfg-inc w-3 h-3" value="12" checked> 12m</label>
                                 <label class="flex items-center gap-1 text-[9px] text-paper/60"><input type="checkbox" class="cfg-inc w-3 h-3" value="24" checked> 24m</label>
                                 <div class="flex items-center gap-1 col-span-1">
                                     <input type="checkbox" id="inCfgIncCustom" class="w-3 h-3">
                                     <input type="number" id="inCfgIncVal" class="w-full bg-white/5 border border-white/10 text-[9px] p-1 rounded" placeholder="Mes" disabled>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>

                <button id="btnRun" class="cta-button w-full py-4 text-sm flex justify-center items-center gap-2 group">
                    <span>SIMULAR PENSIONES</span>
                    <i class="ph ph-arrow-right font-bold group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>

            <!-- Content Area -->
            <div class="lg:col-span-8">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center glass-panel p-12 text-center">
                    <div class="w-20 h-20 bg-oceanLight/50 rounded-full flex items-center justify-center mb-6 animate-pulse">
                        <i class="ph ph-calculator text-4xl text-acid"></i>
                    </div>
                    <h3 class="font-serif text-2xl text-paper italic">Resultados de Simulación</h3>
                    <p class="text-white/40 max-w-sm mx-auto mt-2 text-sm">Ingrese los datos técnicos obligatorios para proyectar su flujo de jubilación.</p>
                </div>

                <div id="resultsDashboard" class="hidden space-y-8 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="font-serif text-3xl italic text-paper">Resultados Consolidado</h2>
                        <div class="flex gap-2">
                            <button id="btnSave" class="bg-white/5 hover:bg-white/10 text-white px-3 py-2 rounded text-[10px] font-bold tracking-widest border border-white/10 flex items-center gap-2">
                                <i class="ph ph-cloud-arrow-up"></i> GUARDAR
                            </button>
                            <button id="btnPDF" class="bg-acid/10 hover:bg-acid/20 text-acid px-3 py-2 rounded text-[10px] font-bold tracking-widest border border-acid/20 flex items-center gap-2">
                                <i class="ph ph-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="glass-panel p-5 border-t-2 border-acid/50">
                            <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Capital Final</span>
                            <div class="text-xl font-mono font-bold text-acid mt-1" id="resCap">$0</div>
                        </div>
                        <div class="glass-panel p-5 border-t-2 border-sky-400/50">
                            <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">PGU Estimada</span>
                            <div class="text-xl font-mono font-bold text-sky-400 mt-1" id="resPgu">$0</div>
                        </div>
                        <div class="glass-panel p-5 border-t-2 border-purple-500/50">
                            <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">SIS Calculado</span>
                            <div class="text-xl font-mono font-bold text-purple-400 mt-1" id="resSis">$0</div>
                        </div>
                        <div class="glass-panel p-5 border-t-2 border-pink-500/50">
                            <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Bono Hijo</span>
                            <div class="text-xl font-mono font-bold text-pink-400 mt-1" id="resHijo">$0</div>
                        </div>
                    </div>

                    <div id="resultsTables" class="space-y-6"></div>

                    <div class="glass-panel p-8">
                        <h3 class="text-xl font-serif italic text-paper mb-6">Proyección de Renta</h3>
                        <div class="h-[350px] w-full"><canvas id="mainChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-10 right-10 z-[100] transform translate-y-20 opacity-0 transition-all duration-500 pointer-events-none">
        <div class="glass-panel px-6 py-4 border-acid/30 flex items-center gap-4 shadow-2xl">
            <div id="toastIcon" class="text-acid text-2xl"></div>
            <div id="toastMsg" class="text-sm font-bold tracking-tight"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global State
        const state = { uf: 38500, utm: 66600, userId: null, chart: null, lastResult: null };
        const config = { pgu_max: 214296, pgu_cutoff: 19.5, pgu_limit: 31.0 };

        // Firebase Init (Rule 3)
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'la-justa-v4';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();
        onAuthStateChanged(auth, u => { if(u) state.userId = u.uid; });

        // Helpers
        const formatCLP = n => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(n);
        const cleanVal = id => { const v = document.getElementById(id).value; return v ? parseFloat(v.replace(/\./g, '').replace(',', '.')) : 0; };
        
        // RUT Formatting
        document.getElementById('inRut').addEventListener('input', e => {
            let v = e.target.value.replace(/[^0-9kK]/g, "").toUpperCase();
            if (v.length > 1) {
                const dv = v.slice(-1);
                const body = v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                e.target.value = `${body}-${dv}`;
            }
            const icon = document.getElementById('rutCheck');
            icon.innerHTML = v.length > 7 ? '<i class="ph ph-check-circle text-acid"></i>' : '';
        });

        // Currency Formatting
        document.querySelectorAll('.currency').forEach(el => {
            el.addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                e.target.value = v ? new Intl.NumberFormat('es-CL').format(v) : '';
            });
        });

        // Custom config toggles
        document.getElementById('inCfgGarCustom').onclick = e => document.getElementById('inCfgGarVal').disabled = !e.target.checked;
        document.getElementById('inCfgIncCustom').onclick = e => document.getElementById('inCfgIncVal').disabled = !e.target.checked;
        document.getElementById('inCheckEld').onclick = e => document.getElementById('inEldAmount').classList.toggle('hidden', !e.target.checked);

        async function fetchIndicators() {
            try {
                const r = await fetch('https://mindicador.cl/api');
                const d = await r.json();
                state.uf = d.uf.valor;
                state.utm = d.utm.valor;
                document.getElementById('navUF').value = new Intl.NumberFormat('es-CL').format(state.uf);
                document.getElementById('navUTM').value = new Intl.NumberFormat('es-CL').format(state.utm);
            } catch (e) {}
        }

        function runSimulation() {
            const firstName = document.getElementById('inFirstName').value;
            const balance = cleanVal('inBalance');
            if(!firstName || balance <= 0) { notify("Complete campos obligatorios", "error"); return; }

            const dob = new Date(document.getElementById('inDob').value || '1960-01-01');
            const age = Math.floor((new Date() - dob) / (365.25 * 86400000)) || 65;
            const gender = document.getElementById('inGender').value;
            const hasSpouse = document.getElementById('inHasSpouse').checked;
            
            let capital = balance + cleanVal('inBonoRec') + cleanVal('inApv');
            const eld = document.getElementById('inCheckEld').checked ? cleanVal('inEldAmount') : 0;
            capital -= eld;

            const cnu = hasSpouse ? 13.5 : 12.2; // Factor simplificado
            const pgu = age >= 65 ? ( (capital/state.uf/cnu < config.pgu_cutoff) ? config.pgu_max : 0 ) : 0;

            // Modos de cálculo
            const modes = [];
            // RP
            modes.push({ name: 'Retiro Programado', uf: (capital / state.uf) / cnu, color: '#CCFF00' });
            // RV Simples
            modes.push({ name: 'RV Simple Inmediata', uf: ((capital / state.uf) / cnu) * 0.94, color: '#38bdf8' });
            
            // RV Garantizadas
            document.querySelectorAll('.cfg-gar:checked').forEach(cb => {
                modes.push({ name: `RV Garantizada ${cb.value}m`, uf: ((capital / state.uf) / cnu) * 0.92, color: '#a855f7' });
            });
            if(document.getElementById('inCfgGarCustom').checked) {
                const val = document.getElementById('inCfgGarVal').value;
                if(val) modes.push({ name: `RV Garantizada ${val}m`, uf: ((capital / state.uf) / cnu) * 0.91, color: '#f472b6' });
            }

            // Renta Aumentada Logic
            const incPct = cleanVal('inIncPct') || 100;
            const incModes = [];
            document.querySelectorAll('.cfg-inc:checked').forEach(cb => {
                incModes.push({ name: `Aumentada ${cb.value}m (+${incPct}%)`, months: parseInt(cb.value), factor: 1 + (incPct/100) });
            });
            if(document.getElementById('inCfgIncCustom').checked) {
                const val = document.getElementById('inCfgIncVal').value;
                if(val) incModes.push({ name: `Aumentada ${val}m (+${incPct}%)`, months: parseInt(val), factor: 1 + (incPct/100) });
            }

            state.lastResult = { client: firstName, capital, eld, pgu, modes, incModes };
            renderResults(state.lastResult);
            notify("Simulación completada", "success");
        }

        function renderResults(data) {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsDashboard').classList.remove('hidden');
            
            document.getElementById('resCap').innerText = formatCLP(data.capital);
            document.getElementById('resPgu').innerText = formatCLP(data.pgu);
            document.getElementById('resSis').innerText = formatCLP(0);

            const cont = document.getElementById('resultsTables');
            cont.innerHTML = `
                <div class="glass-panel overflow-hidden">
                    <table class="w-full text-left text-[10px]">
                        <thead class="bg-white/5 text-acid uppercase tracking-widest">
                            <tr>
                                <th class="p-4">Modalidad</th>
                                <th class="p-4 text-right">Pensión UF</th>
                                <th class="p-4 text-right">Monto Bruto</th>
                                <th class="p-4 text-right">Líquido Estimado</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            ${data.modes.map(m => {
                                const bruto = m.uf * state.uf;
                                const liq = bruto * 0.93 + data.pgu;
                                return `<tr class="hover:bg-white/5">
                                    <td class="p-4 font-bold text-paper">${m.name}</td>
                                    <td class="p-4 text-right font-mono">${m.uf.toFixed(2)}</td>
                                    <td class="p-4 text-right font-mono">${formatCLP(bruto)}</td>
                                    <td class="p-4 text-right font-mono text-acid text-sm font-bold">${formatCLP(liq)}</td>
                                </tr>`;
                            }).join('')}
                            ${data.incModes.map(im => {
                                const baseUf = (data.modes[1].uf); // Usar RV Simple como base
                                const tempUf = baseUf * im.factor;
                                const liq = (tempUf * state.uf * 0.93) + data.pgu;
                                return `<tr class="hover:bg-white/5 bg-acid/5">
                                    <td class="p-4 font-bold text-acid italic">${im.name}</td>
                                    <td class="p-4 text-right font-mono">${tempUf.toFixed(2)}</td>
                                    <td class="p-4 text-right font-mono">${formatCLP(tempUf * state.uf)}</td>
                                    <td class="p-4 text-right font-mono text-acid text-sm font-bold underline">${formatCLP(liq)}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            updateChart(data);
        }

        function updateChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(state.chart) state.chart.destroy();
            const labels = Array.from({length: 21}, (_, i) => `Año ${i}`);
            
            const datasets = data.modes.slice(0, 3).map(m => ({
                label: m.name,
                data: labels.map((_, i) => (m.uf * state.uf * (m.name.includes('Programado') ? Math.pow(0.98, i) : 1)) + data.pgu),
                borderColor: m.color,
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0
            }));

            if(data.incModes.length > 0) {
                const im = data.incModes[0];
                const baseUf = data.modes[1].uf;
                datasets.push({
                    label: 'Impacto Aumentada',
                    data: labels.map((_, i) => (i*12 < im.months ? baseUf * im.factor * state.uf : baseUf * 0.8 * state.uf) + data.pgu),
                    borderColor: '#f87171',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0
                });
            }

            state.chart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { 
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } } },
                        x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } } }
                    }
                }
            });
        }

        async function saveLead() {
            if(!state.lastResult || !state.userId) { notify("Simule resultados primero", "error"); return; }
            try {
                const coll = collection(db, 'artifacts', appId, 'public', 'data', 'leads');
                await addDoc(coll, { ...state.lastResult, rut: document.getElementById('inRut').value, phone: document.getElementById('inEmail').value, timestamp: new Date().toISOString() });
                notify("Lead guardado exitosamente", "success");
            } catch (e) { notify("Error al conectar con la nube", "error"); }
        }

        function notify(msg, type) {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            document.getElementById('toastMsg').innerText = msg;
            icon.innerHTML = type === 'success' ? '<i class="ph ph-check-circle"></i>' : '<i class="ph ph-warning-circle text-red-500"></i>';
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        document.getElementById('btnRun').onclick = runSimulation;
        document.getElementById('btnSave').onclick = saveLead;
        document.getElementById('refreshUF').onclick = fetchIndicators;
        window.onload = () => { fetchIndicators(); lucide.createIcons(); };
    </script>
</body>
</html>
